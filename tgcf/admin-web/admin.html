<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://static.cloudflareinsights.com; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; connect-src 'self'  https://longlong.baby https://dao.longlong.baby http://47.83.203.60;">
    <title>后台管理系统 - 天官赐福</title>
    <script>
      /**
       * 检查管理员登录状态
       * 如果未登录则跳转到登录页面
       */
      function checkAdminLoginStatus() {
        const adminToken = localStorage.getItem('admin_token');
        const adminUser = localStorage.getItem('admin_user');
        
        if (!adminToken || !adminUser) {
          // 未登录，跳转到登录页面
          window.location.href = '../user-web/登录页面.html';
          return false;
        }
        
        // 验证token格式（简单验证）
        if (adminToken.length < 10) {
          localStorage.removeItem('admin_token');
          localStorage.removeItem('admin_user');
          localStorage.removeItem('admin_role');
          window.location.href = '../user-web/登录页面.html';
          return false;
        }
        
        return true;
      }

      /**
       * 资源加载错误处理函数
       * @param {HTMLElement} element - 加载失败的DOM元素
       */
      function handleResourceError(element) {
        if (typeof console !== 'undefined' && typeof console.error === 'function') {
          console.error(`资源加载失败: ${element.href || element.src}`);
        }
        // 尝试备用路径
        if (element && element.tagName === 'LINK') {
          const backupPath = element.href && element.href.includes('bootstrap.min.css') 
            ? '../css/bootstrap.min.css' 
            : '../icons-1.11.1/font/bootstrap-icons.min.css';
          element.href = backupPath;
          if (typeof console !== 'undefined' && typeof console.log === 'function') {
            console.log(`尝试备用路径: ${backupPath}`);
          }
        }
      }

      /**
       * 获取API基础URL
       * 根据当前访问域名自动选择API地址
       */
      function getApiBaseUrl() {
        const currentHost = window.location.hostname;
        const currentProtocol = window.location.protocol;
        
        // 本地开发环境
        if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
          return 'http://localhost:3003/api';
        }
        
        // 生产环境 - 根据域名选择对应的API地址
        if (currentHost === 'longlong.baby' || currentHost === 'www.longlong.baby') {
          return 'https://longlong.baby/api';
        } else if (currentHost === 'dao.longlong.baby') {
          return 'https://dao.longlong.baby/api';
        } else if (currentHost === '47.83.203.60') {
          return `${currentProtocol}//47.83.203.60/api`;
        }
        
        // 默认使用相对路径
        return '/api';
      }

      /**
       * 修复图片URL
       * 根据当前环境正确处理图片路径
       */
      function fixImageUrl(url) {
        if (!url) return url;
        
        const currentProtocol = window.location.protocol;
        const currentHost = window.location.hostname;
        
        // 本地开发环境处理
        if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
          if (url.startsWith('/uploads/') || url.includes('/uploads/')) {
            const fileName = url.split('/uploads/').pop();
            return `http://localhost:3003/node-backend/uploads/${fileName}`;
          }
          if (url.startsWith('http://localhost:3003/')) {
            return url;
          }
        }
        
        // 生产环境处理
        else {
          if (url.startsWith('/uploads/') || url.includes('/uploads/')) {
            const apiBaseUrl = getApiBaseUrl().replace('/api', '');
            const fileName = url.split('/uploads/').pop();
            return `${apiBaseUrl}/node-backend/uploads/${fileName}`;
          }
          return url;
        }
        
        return url;
      }

      /**
       * 修复API调用URL
       * 替换硬编码的localhost:3003为动态API地址
       */
      function fixApiUrls() {
        const apiBaseUrl = getApiBaseUrl();
        
        // 替换所有硬编码的API地址
        const scripts = document.querySelectorAll('script');
        scripts.forEach(script => {
          if (script.textContent) {
            script.textContent = script.textContent.replace(
              /http:\/\/localhost:3003\/api/g, 
              apiBaseUrl
            );
          }
        });
      }

      // 页面加载完成后修复API URL并检查登录状态
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          fixApiUrls();
          checkAdminLoginStatus();
        });
      } else {
        fixApiUrls();
        checkAdminLoginStatus();
      }
    </script>
    <link href="../css/bootstrap.min.css" rel="stylesheet" onerror="handleResourceError(this)" />
    <link
      rel="stylesheet"
      href="../icons-1.11.1/font/bootstrap-icons.min.css"
      onerror="handleResourceError(this)"
    />
    <link href="../css/responsive-enhanced.css" rel="stylesheet" onerror="handleResourceError(this)" />
    <style>
      /* CSS变量定义 - 天官赐福仙侠风格 */
      :root {
        --primary-color: #8b4513; /* 古铜色 */
        --primary-light: #a0522d; /* 赭石色 */
        --primary-dark: #654321; /* 深褐色 */
        --accent-color: #daa520; /* 金色 */
        --accent-light: #f0e68c; /* 浅金色 */
        --text-primary: #2f4f4f; /* 深石板灰 */
        --text-secondary: #696969; /* 暗灰色 */
        --text-light: #f5f5dc; /* 米色 */
        --bg-primary: #fdf6e3; /* 浅米色 */
        --bg-secondary: #fffaf0; /* 亚麻色 */
        --border-color: #deb887; /* 浅褐色 */
        --shadow-light: 0 2px 8px rgba(139, 69, 19, 0.1);
        --shadow-medium: 0 4px 16px rgba(139, 69, 19, 0.15);
        --shadow-heavy: 0 8px 32px rgba(139, 69, 19, 0.2);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* 全局样式 */
      body {
        font-family: "Microsoft YaHei", "SimSun", "KaiTi", serif;
        background: linear-gradient(135deg, #fdf6e3 0%, #fffaf0 100%);
        color: var(--text-primary);
        line-height: 1.8;
        min-height: 100vh;
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="clouds" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="3" fill="%23deb887" opacity="0.1"/><circle cx="80" cy="40" r="4" fill="%23deb887" opacity="0.1"/><circle cx="60" cy="80" r="2" fill="%23deb887" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23clouds)"/></svg>');
      }

      /* 导航栏样式 - 天官风格 */
      .navbar {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
        color: var(--text-light);
        box-shadow: var(--shadow-medium);
        padding: 0.8rem 1.5rem;
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 1000;
        border-bottom: 2px solid var(--accent-color);
      }

      .navbar-brand {
        color: var(--accent-light);
        font-weight: 700;
        font-size: 1.6rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      }

      .navbar-brand:hover {
        color: var(--accent-color);
      }

      /* 侧边栏样式 - 仙官风格 */
      .sidebar {
        background: linear-gradient(
          180deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
        color: var(--text-light);
        width: 280px;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        padding-top: 76px;
        box-shadow: var(--shadow-medium);
        transition: var(--transition);
        border-right: 2px solid var(--accent-color);
        overflow-y: auto;
        overflow-x: hidden;
      }

      .sidebar::-webkit-scrollbar {
        width: 6px;
      }

      .sidebar::-webkit-scrollbar-track {
        background: rgba(139, 69, 19, 0.2);
      }

      .sidebar::-webkit-scrollbar-thumb {
        background: var(--accent-color);
        border-radius: 3px;
      }

      .sidebar::-webkit-scrollbar-thumb:hover {
        background: var(--accent-light);
      }

      .sidebar-link {
        display: block;
        color: var(--text-light);
        text-decoration: none;
        padding: 14px 28px;
        transition: var(--transition);
        border-left: 4px solid transparent;
        font-size: 1.1rem;
        font-weight: 500;
        margin: 4px 0;
      }

      .sidebar-link:hover,
      .sidebar-link.active {
        background: rgba(218, 165, 32, 0.2);
        color: var(--accent-light);
        border-left-color: var(--accent-color);
        padding-left: 32px;
        transform: translateX(4px);
      }

      .sidebar-link i {
        margin-right: 12px;
        width: 24px;
        text-align: center;
        font-size: 1.2rem;
      }

      /* 上传进度条样式 */
      .upload-progress {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        min-width: 300px;
        text-align: center;
      }
      
      .progress-bar-container {
        width: 100%;
        height: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        overflow: hidden;
        margin: 15px 0;
      }
      
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #9e2a2b 0%, #daa520 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
        width: 0%;
      }
      
      .upload-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
      }

      /* 主内容区 */
      .main-content {
        margin-left: 280px;
        padding: 100px 40px 40px;
        transition: var(--transition);
      }

      /* 卡片样式 - 卷轴风格 */
      .card {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: var(--shadow-light);
        margin-bottom: 24px;
        background: var(--bg-secondary);
        transition: var(--transition);
        background-image: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.8),
          rgba(255, 250, 240, 0.9)
        );
      }

      .card:hover {
        box-shadow: var(--shadow-medium);
        transform: translateY(-2px);
        border-color: var(--accent-color);
      }

      .card-header {
        background: linear-gradient(
          135deg,
          var(--primary-light) 0%,
          var(--primary-color) 100%
        );
        color: var(--text-light);
        border-radius: 8px 8px 0 0;
        border: none;
        padding: 1.2rem 1.8rem;
        font-weight: 600;
        font-size: 1.2rem;
        border-bottom: 2px solid var(--accent-color);
      }

      .card-body {
        padding: 1.8rem;
      }

      /* 按钮样式 - 古风按钮 */
      .btn {
        border-radius: 6px;
        padding: 10px 20px;
        font-weight: 500;
        transition: var(--transition);
        box-shadow: var(--shadow-light);
        border: 1px solid var(--border-color);
        font-family: "Microsoft YaHei", "SimSun", serif;
      }

      .btn:hover {
        box-shadow: var(--shadow-medium);
        transform: translateY(-1px);
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-light) 0%,
          var(--primary-color) 100%
        );
        color: var(--text-light);
        border-color: var(--primary-dark);
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #b8860b 0%, #8b6914 100%);
        color: var(--accent-light);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(218, 165, 32, 0.3);
      }

      .btn-danger {
        background: linear-gradient(135deg, #8b0000 0%, #b22222 100%);
        color: var(--text-light);
        border-color: #8b0000;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #a9a9a9 0%, #808080 100%);
        color: var(--text-light);
        border-color: #696969;
      }

      /* 表格样式 */
      .table {
        margin-bottom: 0;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        overflow: hidden;
      }

      .table th {
        background: linear-gradient(
          135deg,
          var(--primary-light) 0%,
          var(--primary-color) 100%
        );
        color: var(--text-light);
        font-weight: 600;
        border-bottom: 2px solid var(--accent-color);
        padding: 14px 18px;
        font-size: 1.1rem;
      }

      .table td {
        padding: 12px 18px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }

      .table-hover tbody tr:hover {
        background: rgba(218, 165, 32, 0.1);
      }

      /* 表单样式 */
      .form-control {
        border-radius: 6px;
        border: 1px solid var(--border-color);
        padding: 10px 14px;
        transition: var(--transition);
        background: var(--bg-secondary);
        font-family: "Microsoft YaHei", "SimSun", serif;
      }

      .form-control:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(218, 165, 32, 0.1);
        outline: none;
        background: var(--text-light);
      }

      .form-label {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1.1rem;
      }

      /* 模态框样式 */
      .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: var(--shadow-heavy);
      }

      /* 悬浮提示条样式 */
      .error-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 300px;
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 16px rgba(255, 152, 0, 0.3);
        padding: 12px 16px;
        margin: 0;
      }

      /* 移动端菜单按钮 */
      .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        color: var(--text-light);
        font-size: 1.5rem;
        padding: 0.5rem;
        cursor: pointer;
      }

      /* 侧边栏遮罩层 */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      /* 基本信息表格样式 */
      .info-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
      }

      .info-table td:first-child {
        font-weight: bold;
        background-color: #f1f1f1;
        width: 20%;
      }

      .info-table td {
        border: 1px solid #ddd;
        padding: 12px 15px;
      }

      tbody,
      td,
      tfoot,
      th,
      thead,
      tr {
        border-color: inherit;
        border-style: solid;
        border-width: 0;
      }

      /* 响应式设计 */
      @media (max-width: 1200px) {
        .sidebar {
          width: 260px;
        }

        .main-content {
          margin-left: 260px;
          padding: 100px 30px 30px;
        }
      }

      @media (max-width: 992px) {
        .sidebar {
          width: 240px;
        }

        .main-content {
          margin-left: 240px;
          padding: 100px 25px 25px;
        }

        .card-body {
          padding: 1.5rem;
        }

        .table th,
        .table td {
          padding: 10px 12px;
          font-size: 0.9rem;
        }
      }

      @media (max-width: 768px) {
        .mobile-menu-btn {
          display: block;
        }

        .sidebar {
          width: 280px;
          transform: translateX(-100%);
          z-index: 1001;
        }

        .sidebar.show {
          transform: translateX(0);
        }

        .sidebar-overlay.show {
          display: block;
        }

        .main-content {
          margin-left: 0;
          padding: 100px 20px 20px;
        }

        .navbar-brand {
          font-size: 1.3rem;
        }

        .card-header {
          padding: 1rem 1.2rem;
          font-size: 1.1rem;
        }

        .card-body {
          padding: 1.2rem;
        }

        .table-responsive {
          font-size: 0.85rem;
        }

        .table th,
        .table td {
          padding: 8px 10px;
        }

        .btn {
          padding: 8px 16px;
          font-size: 0.9rem;
        }

        .btn-sm {
          padding: 6px 12px;
          font-size: 0.8rem;
        }

        .action-buttons {
          flex-direction: column;
          gap: 4px;
        }

        .action-buttons .btn {
          width: 100%;
          margin-bottom: 2px;
        }

        .error-toast {
          max-width: 250px;
          right: 10px;
          top: 10px;
          font-size: 0.9rem;
        }
      }

      @media (max-width: 576px) {
        .navbar {
          padding: 0.6rem 1rem;
        }

        .navbar-brand {
          font-size: 1.1rem;
        }

        .main-content {
          padding: 90px 15px 15px;
        }

        .display-4 {
          font-size: 1.8rem;
        }

        .lead {
          font-size: 1.1rem;
        }

        .card-header {
          padding: 0.8rem 1rem;
          font-size: 1rem;
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .card-header .d-flex {
          width: 100%;
          justify-content: space-between;
        }

        .card-body {
          padding: 1rem;
        }

        .table th,
        .table td {
          padding: 6px 8px;
          font-size: 0.8rem;
        }

        .table th:nth-child(n + 5),
        .table td:nth-child(n + 5) {
          display: none;
        }

        .btn {
          padding: 6px 12px;
          font-size: 0.8rem;
        }

        .btn-sm {
          padding: 4px 8px;
          font-size: 0.75rem;
        }

        .modal-dialog {
          margin: 1rem 0.5rem;
        }

        .modal-body {
          padding: 1rem;
        }

        .form-control {
          padding: 8px 12px;
          font-size: 0.9rem;
        }

        .error-toast {
          left: 10px;
          right: 10px;
          max-width: none;
          top: 10px;
          font-size: 0.85rem;
        }
      }

      @media (max-width: 480px) {
        .sidebar {
          width: 100%;
        }

        .display-4 {
          font-size: 1.5rem;
          text-align: center;
        }

        .lead {
          font-size: 1rem;
          text-align: center;
        }

        .table th:nth-child(n + 4),
        .table td:nth-child(n + 4) {
          display: none;
        }

        .action-buttons .btn {
          font-size: 0.7rem;
          padding: 4px 6px;
        }
      }

      /* 状态标签样式 */
      .badge {
        border-radius: 16px;
        padding: 4px 12px;
        font-weight: 500;
        font-size: 0.875rem;
      }

      .badge-success {
        background: linear-gradient(135deg, #81c784 0%, #4caf50 100%);
      }

      .badge-warning {
        background: linear-gradient(135deg, #daa520 0%, #b8860b 100%);
      }

      .badge-danger {
        background: linear-gradient(135deg, #e57373 0%, #f44336 100%);
      }

      /* 操作按钮组 */
      .action-buttons {
        display: flex;
        gap: 8px;
      }

      /* 加载状态动画 */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-out;
      }

      /* 消息框样式 */
      .message-container {
        max-height: 400px;
        overflow-y: auto;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      /* 密码输入框包装器 */
      .password-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
      }

      .password-input-wrapper .form-control {
        padding-right: 50px;
      }

      /* 密码切换按钮 */
      .password-toggle {
        position: absolute;
        right: 15px;
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        z-index: 2;
      }

      .password-toggle:hover {
        color: var(--primary-color);
      }

      .password-toggle i {
        font-size: 16px;
      }
      
      /* 图片验证样式 */
      .form-control.is-valid {
        border-color: #28a745;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.8-.77-.8-.77-.8.77.8.77zm1.4-2.77L8 8l-.8-.77-3.5-3.5-.8.77z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      }
      
      .form-control.is-invalid {
        border-color: #dc3545;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 4.6 2.4 2.4m0-2.4L5.8 7'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      }

      .message-box {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 12px 16px;
        margin-bottom: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .message-box:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
      }

      /* 管理员消息框样式 */
      .message-box.admin-message {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
        border: 1px solid var(--primary-light);
        color: var(--text-light);
      }

      /* 用户消息框样式 */
      .message-box.user-message {
        background: white;
        border: 1px solid #e0e0e0;
      }

      .message-content {
        font-size: 14px;
        line-height: 1.5;
        color: #333;
        margin-bottom: 8px;
      }

      /* 管理员消息内容样式 */
      .message-box.admin-message .message-content {
        color: var(--text-light);
      }

      .message-time {
        font-size: 12px;
        color: #666;
        text-align: right;
      }

      /* 管理员消息时间样式 */
      .message-box.admin-message .message-time {
        color: rgba(245, 245, 220, 0.8);
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .message-sender {
        font-size: 12px;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 12px;
      }

      .message-sender.admin-message {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
        color: white;
      }

      .message-sender.user-message {
        background: linear-gradient(
          180deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
        color: white;
      }

      .message-input-area {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .message-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }

      .send-btn {
        padding: 10px 20px;
        background: linear-gradient(
          180deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      
      /* 用户列表样式 */
      .user-item {
        transition: all 0.3s ease;
        border: none !important;
        margin-bottom: 2px;
      }
      
      .user-item:hover {
        background: rgba(139, 69, 19, 0.1) !important;
        transform: translateX(2px);
      }
      
      .user-item.active {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%) !important;
        color: white !important;
      }
      
      .user-item.active .text-muted {
        color: rgba(255, 255, 255, 0.8) !important;
      }
      
      .user-item.active .badge {
        background: rgba(255, 255, 255, 0.2) !important;
        color: white !important;
      }
      
      #usersList {
        background: white;
      }
      
      #usersList::-webkit-scrollbar {
        width: 6px;
      }
      
      #usersList::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }
      
      #usersList::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 3px;
      }
      
      #usersList::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
      }
    </style>
  </head>
  <body>
    <!-- 添加密码修改模态框 -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="changePasswordModalLabel">修改管理员密码</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="changePasswordAdminId">
            
            <div class="mb-3">
              <label for="currentPassword" class="form-label">当前密码</label>
              <div class="input-group">
                <input type="password" class="form-control" id="currentPassword" placeholder="请输入当前密码" required>
                <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('currentPassword')">
                  <i class="bi bi-eye" id="currentPassword-eye"></i>
                </button>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="newPassword" class="form-label">新密码</label>
              <div class="input-group">
                <input type="password" class="form-control" id="newPassword" placeholder="请输入新密码" required>
                <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('newPassword')">
                  <i class="bi bi-eye" id="newPassword-eye"></i>
                </button>
              </div>
              <div class="mt-1" id="passwordStrength"></div>
            </div>
            
            <div class="mb-3">
              <label for="confirmPassword" class="form-label">确认新密码</label>
              <div class="input-group">
                <input type="password" class="form-control" id="confirmPassword" placeholder="请再次输入新密码" required>
                <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('confirmPassword')">
                  <i class="bi bi-eye" id="confirmPassword-eye"></i>
                </button>
              </div>
              <div class="mt-1" id="passwordMatch" style="display: none;"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" onclick="confirmChangePassword()">确认修改</button>
          </div>
        </div>
      </div>
    </div>
    
    <nav class="navbar navbar-expand-lg fixed-top navbar-responsive">
      <div class="container-fluid container-fluid-responsive">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">
          <i class="bi bi-list"></i>
        </button>
        <a class="navbar-brand text-white" href="#">
          <i class="bi bi-shield-check"></i>
          <span class="d-none d-sm-inline">天官赐福管理系统</span>
          <span class="d-inline d-sm-none">管理系统</span>
        </a>
        <div class="d-flex align-items-center">
          <span class="text-white me-3 d-none d-md-inline" id="adminWelcome"
            >管理员</span
          >
          <div class="dropdown me-2">
            <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-person-circle"></i>
              <span class="d-none d-sm-inline">账户</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="changePassword()">
                <i class="bi bi-key me-2"></i>修改密码
              </a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="logout()">
                <i class="bi bi-box-arrow-right me-2"></i>退出登录
              </a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <div class="sidebar-overlay" onclick="closeSidebar()"></div>
    <div class="sidebar" id="sidebar">
      <div>
        <a href="#" class="sidebar-link active" onclick="switchPage('home')">
          <i class="bi bi-house"></i>
          <span>首页管理</span>
        </a>
        <a href="#" class="sidebar-link" onclick="switchPage('characters')">
          <i class="bi bi-people"></i>
          <span>角色管理</span>
        </a>
        <a href="#" class="sidebar-link" onclick="switchPage('story')">
          <i class="bi bi-book"></i>
          <span>剧情简介</span>
        </a>
        <a href="#" class="sidebar-link" onclick="switchPage('reviews')">
          <i class="bi bi-star"></i>
          <span>作品评价</span>
        </a>
        <a href="#" class="sidebar-link" onclick="switchPage('quotes')">
          <i class="bi bi-chat-quote"></i>
          <span>人物语录</span>
        </a>
        <a href="#" class="sidebar-link" onclick="switchPage('messages')">
          <i class="bi bi-chat-dots"></i>
          <span>留言管理</span>
        </a>
        <a href="#" class="sidebar-link" onclick="switchPage('carousel')">
          <i class="bi bi-images"></i>
          <span>轮播图管理</span>
        </a>
        <a href="#" class="sidebar-link" onclick="switchPage('chat')">
          <i class="bi bi-chat-dots"></i>
          <span>用户聊天</span>
        </a>
        <a
          href="#"
          class="sidebar-link"
          onclick="switchPage('Basic_Information')"
        >
          <i class="bi bi-info-circle"></i>
          <span>基本信息管理</span>
        </a>
        
        <a href="#" class="sidebar-link" onclick="switchPage('admins')">
          <i class="bi bi-person-gear"></i>
          <span>管理员管理</span>
        </a>
        <a href="#" class="sidebar-link" onclick="changePassword()">
          <i class="bi bi-key"></i>
          <span>修改密码</span>
        </a>
      </div>
    </div>

    <div class="main-content container-responsive">
      <div class="mb-4 mb-md-5 text-center text-md-start">
        <h1
          id="pageTitle"
          class="display-4"
          style="
            color: var(--primary-color);
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
          "
        >
          <i
            class="bi bi-house-fill me-2 me-md-3"
            style="color: var(--accent-color)"
          ></i>
          <span class="d-block d-sm-inline">天官赐福管理</span>
        </h1>
        <p
          id="pageDescription"
          class="lead"
          style="color: var(--text-secondary); font-size: 1.1rem"
        >
          执掌天官事务，管理人间祈愿
        </p>
      </div>

      <div class="card card-responsive" id="defaultContent">
        <div
          class="card-header card-header-responsive d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2"
        >
          <h5 class="mb-0">内容列表</h5>
          <div class="d-flex flex-wrap gap-2">
            <button
              class="btn btn-danger btn-sm"
              onclick="deleteSelected()"
              id="deleteSelectedBtn"
              style="display: none"
            >
              <i class="bi bi-trash"></i>
              <span class="d-none d-sm-inline">删除选中</span>
            </button>
            <button class="btn btn-primary btn-sm" onclick="showAddModal()">
              <i class="bi bi-plus-lg"></i>
              <span class="d-none d-sm-inline">添加内容</span>
            </button>
          </div>
        </div>
        <div class="card-body card-body-responsive">
          <div class="table-responsive table-responsive-custom">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>
                    <input
                      type="checkbox"
                      id="selectAll"
                      onchange="toggleSelectAll()"
                    />
                  </th>
                  <th>ID</th>
                  <th>标题</th>
                  <th id="dynamicHeader3">类型</th>
                  <th id="dynamicHeader4">状态</th>
                  <th>创建时间</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="contentTableBody">
                <tr>
                  <td colspan="7" class="text-center">正在加载...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 消息显示区域 -->
      <div class="card card-responsive" id="chatContent" style="display: none">
        <div class="card-header card-header-responsive">
          <h5 class="mb-0">用户聊天消息</h5>
        </div>
        <div class="card-body card-body-responsive">
          <div class="message-container" id="messageContainer">
            <!-- 消息将在这里显示 -->
          </div>
          <div class="message-input-area">
            <input
              type="text"
              class="message-input"
              id="messageInput"
              placeholder="输入消息..."
              onkeypress="handleKeyPress(event)"
            />
            <input
              type="file"
              id="fileInput"
              accept="image/*,video/*"
              style="display: none"
              onchange="handleFileSelect(event)"
            />
            <button
              class="btn btn-outline-secondary"
              onclick="document.getElementById('fileInput').click()"
              title="上传图片或视频"
            >
              <i class="bi bi-paperclip"></i>
            </button>
            <button class="send-btn" onclick="sendMessage()">
              <i class="bi bi-send"></i> 发送
            </button>
          </div>
          <div
            id="filePreview"
            style="
              display: none;
              margin-top: 10px;
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 6px;
            "
          >
            <div id="previewContent"></div>
            <button class="btn btn-sm btn-danger" onclick="clearFilePreview()">
              取消
            </button>
            <button class="btn btn-sm btn-primary" onclick="sendFileMessage()">
              发送文件
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="../bootstrap-5.3.2/dist/js/bootstrap.bundle.min.js" onerror="handleResourceError(this)"></script>
    <script src="../js/responsive-navigation.js" onerror="handleResourceError(this)"></script>
    <script src="fix-image-validation.js" onerror="handleResourceError(this)"></script>
    <script>
      let currentPage = "home";
      let isLoading = false;

      const formatDateTime = (date = new Date()) => {
        return new Intl.DateTimeFormat("zh-CN", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false,
        }).format(date);
      };

      document.addEventListener("DOMContentLoaded", async function () {
        await checkAuth();
      });

      /**
       * 检查用户权限
       * 如果用户没有管理员权限，跳转到登录页面
       * 如果用户信息不存在，调用getUserInfo获取
       * 如果用户信息存在，更新欢迎信息并初始化页面
       */
      async function checkAuth() {
        try {
          const token = localStorage.getItem("admin_token");
          const userRole = localStorage.getItem("admin_role");

          if (!token || userRole !== "admin") {
            // 权限不够，跳转到登录页面
            alert("权限不够，请先登录管理员账号");
            window.location.href = "../user-web/登录页面.html";
            return;
          } else {
            // 确保用户信息存在，如果不存在则重新获取
            const user = localStorage.getItem("admin_user");
            if (!user) {
              await getUserInfo();
            } else {
              updateAdminWelcome();
              await initPage();
            }
          }
        } catch (error) {
          console.error("权限检查失败:", error);
          alert("权限检查失败，请重新登录");
          window.location.href = "../user-web/登录页面.html";
        }
      }

      // 切换页面功能
      function switchPage(page) {
        currentPage = page;

        // 更新侧边栏激活状态
        document.querySelectorAll(".sidebar-link").forEach((link) => {
          link.classList.remove("active");
        });
        
        // 安全获取点击的链接元素
        const clickedLink = document.querySelector(`[onclick*="switchPage('${page}')"]`);
        if (clickedLink) {
          clickedLink.classList.add("active");
        }

        // 显示/隐藏对应内容
        if (page === "chat") {
          document.getElementById("defaultContent").style.display = "none";
          document.getElementById("chatContent").style.display = "block";
          document.getElementById("pageTitle").innerHTML =
            '<i class="bi bi-chat-dots-fill me-2 me-md-3" style="color: var(--accent-color);"></i><span class="d-block d-sm-inline">用户聊天管理</span>';
          document.getElementById("pageDescription").textContent =
            "查看和管理用户聊天消息";
          renderChatPage(); // 渲染聊天页面结构并加载用户列表
        } else {
          document.getElementById("defaultContent").style.display = "block";
          document.getElementById("chatContent").style.display = "none";
          
          // 更新页面标题和描述
          const pageInfo = {
            home: { title: "首页管理", description: "管理网站首页内容", icon: "bi-house-fill" },
            characters: { title: "角色管理", description: "管理角色信息", icon: "bi-people-fill" },
            story: { title: "剧情简介", description: "管理剧情简介内容", icon: "bi-book-fill" },
            reviews: { title: "作品评价", description: "管理用户评价", icon: "bi-star-fill" },
            quotes: { title: "人物语录", description: "管理人物经典语录", icon: "bi-chat-quote-fill" },
            messages: { title: "留言管理", description: "管理用户留言", icon: "bi-chat-dots-fill" },
            admins: { title: "管理员管理", description: "管理系统管理员账号", icon: "bi-person-gear" },
            Basic_Information: { title: "基本信息管理", description: "管理网站基本信息", icon: "bi-info-circle-fill" },
            carousel: { title: "轮播图管理", description: "管理首页轮播图展示", icon: "bi-images" }
          };
          
          const info = pageInfo[page] || { title: "内容管理", description: "管理系统内容", icon: "bi-house-fill" };
          
          document.getElementById("pageTitle").innerHTML =
            `<i class="bi ${info.icon} me-2 me-md-3" style="color: var(--accent-color);"></i><span class="d-block d-sm-inline">${info.title}</span>`;
          document.getElementById("pageDescription").textContent = info.description;
          
          // 更新表格头部
          updateTableHeaders(page);
          
          // 加载页面数据
          loadPageData(page);
        }

        // 在移动端关闭侧边栏
        if (window.innerWidth <= 768) {
          closeSidebar();
        }
      }

      // 加载聊天消息
      async function loadChatMessages() {
        try {
          const response = await fetch(
            "/api/admin-chat/messages",
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("admin_token")}`,
              },
            },
          );
          const result = await response.json();

          if (result.success) {
            // 转换API数据格式为显示格式
            const messages = result.data.map((msg) => ({
              content: msg.content || "",
              time: new Date(msg.create_time).toLocaleString(),
              sender_name: msg.sender_name || "user", // 确保有默认值
              image_url: msg.image_url || null,
              video_url: msg.video_url || null
            }));
            displayMessages(messages);
          } else {
            console.error("获取聊天记录失败:", result.error);
            // 显示模拟数据
            const mockMessages = [
              {
                content: "欢迎来到天官赐福聊天室！",
                time: formatDateTime(),
                sender_name: "user",
              },
              {
                content: "谢怜真的太帅了！",
                time: formatDateTime(),
                sender_name: "user",
              },
              {
                content: "花城和谢怜的故事好感人",
                time: formatDateTime(),
                sender_name: "user",
              },
            ];
            displayMessages(mockMessages);
          }
        } catch (error) {
          console.error("获取聊天记录失败:", error);
          // 显示模拟数据
          const mockMessages = [
            {
              content: "欢迎来到天官赐福聊天室！",
              time: formatDateTime(),
              sender_name: "user",
            },
            {
              content: "谢怜真的太帅了！",
              time: formatDateTime(),
              sender_name: "user",
            },
            {
              content: "花城和谢怜的故事好感人",
              time: formatDateTime(),
              sender_name: "user",
            },
          ];
          displayMessages(mockMessages);
        }
      }

      // 显示消息
      function displayMessages(messages) {
        const messageContainer = document.getElementById("messageContainer");
        messageContainer.innerHTML = "";

        messages.forEach((message) => {
          addMessageToContainer(message);
        });
      }

      // 添加消息到容器
      function addMessageToContainer(message) {
        const messageContainer = document.getElementById("messageContainer");
        const messageBox = document.createElement("div");

        // 根据发送者决定消息样式
        const isAdmin = message.sender_name === "admin";
        const messageClass = isAdmin ? "admin-message" : "user-message";
        const senderLabel = isAdmin ? "管理员" : message.sender_name || "用户";

        let contentHtml = "";
        if (message.content) {
          contentHtml += `<div class="message-text">${message.content}</div>`;
        }
        if (message.image_url) {
          const fixedImageUrl = fixImageUrl(message.image_url);
          contentHtml += `<img src="${fixedImageUrl}" class="message-image" style="max-width:200px; border-radius:6px; margin-top:5px;" onclick="showImageModal('${fixedImageUrl}')">`;
        }
        if (message.video_url) {
          contentHtml += `<video controls class="message-video" style="max-width:200px; border-radius:6px; margin-top:5px;"><source src="${message.video_url}"></video>`;
        }

        messageBox.className = `message-box fade-in ${messageClass}`;
        messageBox.innerHTML = `
                <div class="message-header">
                    <span class="message-sender ${messageClass}">${senderLabel}</span>
                    <span class="message-time">${message.time}</span>
                </div>
                <div class="message-content">${contentHtml}</div>
            `;

        messageContainer.appendChild(messageBox);
        messageContainer.scrollTop = messageContainer.scrollHeight;
      }

      // 发送消息
      async function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const content = messageInput.value.trim();

        if (!content) {
          alert("请输入消息内容");
          return;
        }
        // 立即显示管理员消息
        const adminMessage = {
          content: content,
          time: formatDateTime(),
          sender_name: "admin",
        };
        addMessageToContainer(adminMessage);

        // 清空输入框
        messageInput.value = "";

        try {
          // 发送消息到后端API
          const response = await fetch(
            "/api/admin-chat/send",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("admin_token")}`,
              },
              body: JSON.stringify({
                sender_name: "admin",
                receiver_name: "all",
                content: content,
              }),
            },
          );

          const result = await response.json();
          if (!result.success) {
            console.error("发送失败:", result.error);
          }
        } catch (error) {
          console.error("发送消息失败:", error);
        }
      }

      // 处理回车键发送
      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      }

      let selectedFile = null;

      // 处理文件选择
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        selectedFile = file;
        const filePreview = document.getElementById("filePreview");
        const previewContent = document.getElementById("previewContent");

        if (file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function (e) {
            previewContent.innerHTML = `<img src="${e.target.result}" style="max-width:150px; border-radius:6px;">`;
          };
          reader.readAsDataURL(file);
        } else if (file.type.startsWith("video/")) {
          const reader = new FileReader();
          reader.onload = function (e) {
            previewContent.innerHTML = `<video controls style="max-width:150px; border-radius:6px;"><source src="${e.target.result}"></video>`;
          };
          reader.readAsDataURL(file);
        }

        filePreview.style.display = "block";
      }

      // 清除文件预览
      function clearFilePreview() {
        selectedFile = null;
        document.getElementById("filePreview").style.display = "none";
        document.getElementById("fileInput").value = "";
      }

      // 发送文件消息
      async function sendFileMessage() {
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append("file", selectedFile);
        formData.append("sender_name", "admin");
        formData.append("receiver_name", "all");

        try {
          const response = await fetch(
            "/api/admin-chat/upload",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("admin_token")}`,
              },
              body: formData,
            },
          );

          const result = await response.json();
          if (result.success) {
            // 立即显示文件消息
            const fileMessage = {
              content: "",
              time: formatDateTime(),
              sender_name: "admin",
              image_url: selectedFile.type.startsWith("image/")
                ? result.data.file_url
                : null,
              video_url: selectedFile.type.startsWith("video/")
                ? result.data.file_url
                : null,
            };
            addMessageToContainer(fileMessage);
            clearFilePreview();
          } else {
            alert("文件发送失败: " + result.error);
          }
        } catch (error) {
          console.error("文件发送失败:", error);
          alert("文件发送失败，请检查网络连接");
        }
      }

      // 显示图片模态框
      function showImageModal(imageUrl) {
        const modal = document.createElement("div");
        modal.innerHTML = `
                <div class="modal fade" id="imageModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">查看图片</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img src="${imageUrl}" class="img-fluid" style="max-width:100%;">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        document.body.appendChild(modal);
        const modalEl = new bootstrap.Modal(
          document.getElementById("imageModal"),
        );
        modalEl.show();
        modalEl._element.addEventListener("hidden.bs.modal", () =>
          modal.remove(),
        );
      }

      /**
       * 初始化页面
       * 应用保存的网站设置，加载首页数据
       */
      async function initPage() {
        // 初始化页面，默认显示首页内容
        // 应用保存的网站设置
        applySiteSettings();
        // 用户信息已经在checkAuth中确保存在，不需要再次获取
        loadPageData("home");
      }

      /**
       * 更新管理员欢迎信息
       * 从localStorage获取用户信息并显示欢迎语
       */
      function updateAdminWelcome() {
        console.log("updateAdminWelcome函数被调用");
        const user = localStorage.getItem("admin_user");
        console.log("localStorage中的admin_user:", user);
        const adminWelcome = document.getElementById("adminWelcome");
        console.log("找到的adminWelcome元素:", adminWelcome);

        if (adminWelcome) {
          if (user) {
            try {
              const userData = JSON.parse(user);
              console.log("解析后的用户信息:", userData);

              // 确保用户名存在
              const username =
                userData.username ||
                userData.userName ||
                userData.name ||
                "管理员";
              adminWelcome.textContent = `欢迎，${username}`;
              console.log("更新后的欢迎信息:", adminWelcome.textContent);
            } catch (e) {
              console.error("解析用户信息失败:", e);
              adminWelcome.textContent = "欢迎，管理员";
            }
          } else {
            console.log("localStorage中没有admin_user，使用默认值");
            adminWelcome.textContent = "欢迎，管理员";
          }
        } else {
          console.error("没有找到id为adminWelcome的元素");
        }
      }

      // 页面加载后直接调用一次，确保欢迎信息显示
      document.addEventListener("DOMContentLoaded", updateAdminWelcome);

      /**
       * 获取用户信息
       * 从localStorage获取用户信息，如果不存在则调用autoLogin获取
       */
      async function getUserInfo() {
        try {
          const user = localStorage.getItem("admin_user");
          if (user) {
            // 如果localStorage中有用户信息，直接更新欢迎信息
            updateAdminWelcome();
            return true;
          } else {
            // 如果localStorage中没有用户信息，调用autoLogin获取
            const success = await autoLogin();
            if (success) {
              updateAdminWelcome();
              return true;
            } else {
              // 自动登录失败，跳转到登录页面
              alert("登录信息已过期，请重新登录");
              window.location.href = "../user-web/登录页面.html";
              return false;
            }
          }
        } catch (error) {
          console.error("获取用户信息失败:", error);
          alert("获取用户信息失败，请重新登录");
          window.location.href = "../user-web/登录页面.html";
          return false;
        }
      }

      function closeSidebar() {
        // 关闭侧边栏
      }

      function showAddModal() {
        // 显示添加模态框
      }

      function deleteSelected() {
        // 删除选中项
      }

      function toggleSelectAll() {
        const selectAll = document.getElementById("selectAll");
        const checkboxes = document.querySelectorAll(".item-checkbox");
        checkboxes.forEach((cb) => (cb.checked = selectAll.checked));
        updateDeleteButton();
      }



      // 移动端侧边栏控制函数
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.querySelector(".sidebar-overlay");

        sidebar.classList.toggle("show");
        overlay.classList.toggle("show");
      }

      function closeSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.querySelector(".sidebar-overlay");

        sidebar.classList.remove("show");
        overlay.classList.remove("show");
      }

      // 监听窗口大小变化
      window.addEventListener("resize", function () {
        if (window.innerWidth > 768) {
          closeSidebar();
        }
      });

      /**
       * 自动登录函数
       */
      /**
       * 自动登录函数
       * 使用默认管理员账号登录系统
       * @returns {boolean} 登录是否成功
       */
      async function autoLogin() {
        try {
          const response = await fetch(
            "/api/admin/login",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username: "admin", password: "admin123" }),
            },
          );

          const result = await response.json();
          console.log("自动登录响应:", result);

          // 统一处理响应数据结构
          if (result.success) {
            const token = result.data?.token || result.token;
            const userInfo = result.data?.user || result.userInfo;

            if (token) {
              localStorage.setItem("admin_token", token);
              localStorage.setItem("admin_role", "admin");

              // 构建完整的用户信息对象
              const fullUserInfo = {
                username: "admin", // 默认用户名
                ...userInfo,
              };

              // 保存用户信息
              localStorage.setItem("user", JSON.stringify(fullUserInfo));
              localStorage.setItem("userInfo", JSON.stringify(fullUserInfo));
              localStorage.setItem("admin_user", JSON.stringify(fullUserInfo));

              console.log("自动登录成功，用户信息已保存:", fullUserInfo);
              return true;
            }
          }

          console.error("自动登录失败:", result.message || result);
          return false;
        } catch (error) {
          console.error("自动登录异常:", error);
          return false;
        }
      }

      /**
       * 验证并刷新令牌
       */
      async function validateAndRefreshToken() {
        const token = localStorage.getItem("admin_token");
        if (!token) {
          // 如果没有令牌，尝试自动登录
          const success = await autoLogin();
          return success ? localStorage.getItem("admin_token") : null;
        }

        try {
          // 验证令牌是否有效
          const response = await fetch(
            "/api/admin/verify",
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            },
          );

          if (!response.ok) {
            // 令牌无效，重新登录
            const success = await autoLogin();
            return success ? localStorage.getItem("admin_token") : null;
          }

          return token;
        } catch (error) {
          console.error("令牌验证失败:", error);
          // 验证失败，重新登录
          const success = await autoLogin();
          return success ? localStorage.getItem("admin_token") : null;
        }
      }

      async function loadPageData(page) {
        console.log(`========== 开始加载页面: ${page} ==========`);
        if (isLoading) {
          console.log("数据正在加载中，跳过重复请求");
          return;
        }

        isLoading = true;
        const tbody = document.getElementById("contentTableBody");
        tbody.innerHTML = 
          '<tr><td colspan="7" class="text-center">正在加载...</td></tr>';

        try {
          // 验证并获取有效令牌
          console.log("开始验证令牌...");
          const validToken = await validateAndRefreshToken();
          if (!validToken) {
            throw new Error("无法获取有效令牌");
          }
          console.log("令牌验证成功");

          let apiUrl = "";
          switch (page) {
            case "home":
              apiUrl = "/api/admin/home-content";
              break;
            case "characters":
              apiUrl = "/api/admin/character";
              break;
            case "story":
              apiUrl = "/api/admin/story-intro";
              break;
            case "reviews":
              apiUrl = "/api/admin/work-review";
              break;
            case "quotes":
              apiUrl = "/api/admin/quotes";
              break;
            case "messages":
              apiUrl = "/api/admin/message";
              break;
            case "admins":
              apiUrl = "/api/admin/admin";
              break;
            case "Basic_Information":
              apiUrl = "/api/admin/basic-info";
              break;
            case "carousel":
              apiUrl = "/api/admin/carousel";
              break;
            case "chat":
              renderChatPage();
              return;
          }

          console.log(`准备调用API: ${apiUrl}`);
          const response = await fetch(apiUrl, {
            headers: {
              Authorization: `Bearer ${validToken}`,
            },
          });
          console.log(`API响应状态: ${response.status}`);

          if (response.ok) {
            const data = await response.json();
            console.log(`API响应数据:`, data);
            if (data.success) {
              renderTable(data.data || [], page);
            } else {
              throw new Error(data.error || "API返回错误");
            }
          } else {
            // 获取错误响应内容
            const errorText = await response.text();
            console.error(`API调用失败: HTTP ${response.status}`, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }
        } catch (error) {
          console.error("API调用失败:", error);
          // 显示模拟数据
          const mockData = getMockData(page);
          renderTable(mockData, page);
          showError("API连接失败，显示模拟数据");
        } finally {
          isLoading = false;
          console.log(`========== 页面加载完成: ${page} ==========`);
        }
      }

      function getMockData(page) {
        const mockData = {
          home: [
            {
              id: 1,
              title: "天官赐福",
              status: "已发布",
              create_time: new Date().toISOString(),
            },
            {
              id: 2,
              title: "作品简介",
              status: "已发布",
              create_time: new Date().toISOString(),
            },
          ],
          characters: [
            {
              id: 1,
              name: "谢怜",
              description:
                "仙乐国太子。一心想拯救苍生，却连自己的国家和父母都守护不了。",
              image_url: "../img/谢伶.jpg",
              status: "已发布",
              create_time: new Date().toISOString(),
            },
            {
              id: 2,
              name: "花城",
              description: "从小受尽虐待，憎恶世界，后成为绝境鬼王。",
              image_url: "../img/花城.jpg",
              status: "已发布",
              create_time: new Date().toISOString(),
            },
          ],
          story: [
            {
              id: 1,
              title: "第一章：初遇",
              status: "已发布",
              create_time: new Date().toISOString(),
            },
            {
              id: 2,
              title: "第二章：相识",
              status: "已发布",
              create_time: new Date().toISOString(),
            },
          ],
          reviews: [
            {
              id: 1,
              username: "书迷A",
              rating: 5,
              status: "已审核",
              create_time: new Date().toISOString(),
            },
            {
              id: 2,
              username: "读者B",
              rating: 4,
              status: "已审核",
              create_time: new Date().toISOString(),
            },
          ],
          quotes: [],
          messages: [
            {
              id: 1,
              username: "游客",
              content: "这部作品很棒！",
              status: "已审核",
              create_time: new Date().toISOString(),
            },
            {
              id: 2,
              username: "粉丝小明",
              content: "故事很精彩！",
              status: "未审核",
              create_time: new Date().toISOString(),
            },
          ],
          Basic_Information: [
            {
              id: 1,
              title: "网站标题",
              content: "天官赐福官方网站",
              status: "已发布",
              create_time: new Date().toISOString(),
            },
            {
              id: 2,
              title: "网站描述",
              content: "天官赐福官方粉丝网站，提供最新资讯和角色介绍",
              status: "已发布",
              create_time: new Date().toISOString(),
            },
            {
              id: 3,
              title: "联系方式",
              content: "contact@tianguancifu.com",
              status: "已发布",
              create_time: new Date().toISOString(),
            },
          ],
        };
        return mockData[page] || [];
      }

      function renderChatPage() {
        const chatContent = document.getElementById("chatContent");
        const cardHeader = chatContent.querySelector(".card-header");
        const cardBody = chatContent.querySelector(".card-body");

        cardHeader.innerHTML = `
                <h5 class="mb-0">用户聊天管理</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm" onclick="refreshChatUsers()">
                        <i class="bi bi-arrow-clockwise"></i> 刷新用户列表
                    </button>
                    <button class="btn btn-success btn-sm" onclick="loadAllMessages()">
                        <i class="bi bi-chat-dots"></i> 查看所有消息
                    </button>
                    <button class="btn btn-info btn-sm" onclick="initChatData()">
                        <i class="bi bi-database-add"></i> 初始化聊天数据
                    </button>
                </div>
            `;

        cardBody.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">用户列表</h6>
                            <span class="badge bg-secondary" id="userCount">0</span>
                        </div>
                        <div id="usersList" class="list-group" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                            <div class="text-center p-3 text-muted">加载中...</div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="chatArea" class="border rounded p-3" style="height: 450px; display: flex; flex-direction: column; background: #f8f9fa;">
                            <div class="text-center text-muted p-4">
                                <i class="bi bi-chat-dots" style="font-size: 3rem; color: #ccc;"></i>
                                <h5 class="mt-3">选择用户开始聊天</h5>
                                <p>从左侧用户列表中选择一个用户查看聊天记录</p>
                                <div class="mt-3">
                                    <small class="text-info">💡 提示：如果没有用户，可以点击上方的"初始化聊天数据"按钮</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        // 设置当前选中的用户
        window.currentChatUser = null;
        loadChatUsers();
      }
      
      // 初始化聊天数据
      async function initChatData() {
        if (!confirm('确定要初始化聊天数据吗？这将创建一些示例用户和消息。')) {
          return;
        }
        
        try {
          // 创建示例消息
          const sampleMessages = [
            {
              sender_name: "test_user",
              receiver_name: "admin",
              content: "你好，我想了解一下天官赐福的剧情"
            },
            {
              sender_name: "demo_user", 
              receiver_name: "admin",
              content: "花城真的太帅了！"
            },
            {
              sender_name: "fan_user",
              receiver_name: "admin", 
              content: "谢怜和花城的故事好感人"
            }
          ];
          
          for (const msg of sampleMessages) {
            await fetch("/api/admin-chat/send", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("admin_token")}`,
              },
              body: JSON.stringify(msg),
            });
          }
          
          // 刷新用户列表
          loadChatUsers();
          alert('聊天数据初始化成功！');
        } catch (error) {
          console.error('初始化聊天数据失败:', error);
          alert('初始化失败，请检查网络连接');
        }
      }

      async function loadChatUsers() {
        try {
          const response = await fetch(
            "/api/admin-chat/users",
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("admin_token")}`,
              },
            },
          );
          const result = await response.json();

          if (result.success) {
            renderUsersList(result.data);
          } else {
            console.error("获取用户列表失败:", result.error);
            renderUsersList([]);
          }
        } catch (error) {
          console.error("获取用户列表失败:", error);
          renderUsersList([]);
        }
      }
      
      // 创建示例用户函数
      async function createSampleUser() {
        try {
          // 发送一条示例消息来创建用户
          const response = await fetch(
            "/api/admin-chat/send",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("admin_token")}`,
              },
              body: JSON.stringify({
                sender_name: "test_user",
                receiver_name: "admin",
                content: "你好，我是测试用户！",
              }),
            },
          );

          const result = await response.json();
          if (result.success) {
            // 刷新用户列表
            loadChatUsers();
            alert("示例用户创建成功！");
          } else {
            alert("创建示例用户失败: " + result.error);
          }
        } catch (error) {
          console.error("创建示例用户失败:", error);
          alert("创建示例用户失败，请检查网络连接");
        }
      }

      function renderUsersList(users) {
        const usersList = document.getElementById("usersList");
        const userCount = document.getElementById("userCount");
        
        if (!users || users.length === 0) {
          usersList.innerHTML = `
            <div class="text-center p-4 text-muted">
              <i class="bi bi-person-x" style="font-size: 2rem;"></i>
              <p class="mt-2 mb-0">暂无聊天用户</p>
              <small>用户发送消息后会出现在这里</small>
              <div class="mt-3">
                <button class="btn btn-sm btn-outline-primary" onclick="createSampleUser()">
                  <i class="bi bi-plus"></i> 创建示例用户
                </button>
              </div>
            </div>`;
          userCount.textContent = '0';
          return;
        }

        userCount.textContent = users.length;
        
        usersList.innerHTML = users
          .map(
            (user, index) => `
                <a href="javascript:void(0)" class="list-group-item list-group-item-action user-item" 
                   onclick="return selectUser('${user.username}', this)" 
                   data-username="${user.username}">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="me-2">
                                <i class="bi bi-person-circle" style="font-size: 1.5rem; color: var(--primary-color);"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">${user.username}</h6>
                                <small class="text-muted">最后活跃</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">${new Date(user.last_message_time).toLocaleString('zh-CN', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})}</small>
                            <div class="mt-1">
                                <span class="badge bg-primary badge-sm">聊天</span>
                            </div>
                        </div>
                    </div>
                </a>
            `,
          )
          .join("");
      }
      
      function selectUser(username, element) {
        // 移除其他用户的选中状态
        document.querySelectorAll('.user-item').forEach(item => {
          item.classList.remove('active');
        });
        
        // 添加当前用户的选中状态
        element.classList.add('active');
        
        // 设置当前聊天用户
        window.currentChatUser = username;
        
        // 加载用户聊天记录
        loadUserChat(username);
        
        // 防止默认链接行为
        return false;
      }

      async function loadUserChat(username) {
        // 验证username参数不能为空
        if (!username || username === "undefined") {
          console.error("用户名不能为空");
          return;
        }

        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(
            `${apiBaseUrl}/admin-chat/messages/${username}`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("admin_token")}`,
              },
            },
          );
          const result = await response.json();

          if (result.success) {
            renderChatArea(username, result.data);
          } else {
            console.error("获取聊天记录失败:", result.error);
            renderChatArea(username, []);
          }
        } catch (error) {
          console.error("获取聊天记录失败:", error);
          renderChatArea(username, []);
        }
      }

      function renderChatArea(username, messages) {
        const chatArea = document.getElementById("chatArea");
        chatArea.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                    <h6 class="mb-0">与 ${username} 的聊天</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadUserChat('${username}')">  
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="flex-grow-1 overflow-auto mb-3" id="messagesContainer" style="max-height: 300px;">
                    ${messages.length === 0 ? 
                      '<div class="text-center text-muted p-3">暂无聊天记录</div>' :
                      messages
                      .map(
                        (msg) => `
                        <div class="mb-2 p-2 ${msg.sender_name === "admin" ? "text-end" : "text-start"}">
                            <div class="d-inline-block p-2 rounded ${msg.sender_name === "admin" ? "text-white" : "bg-light"}" style="max-width: 70%; background-color: ${msg.sender_name === "admin" ? "#B87333" : "#f8f9fa"};">
                                <small class="d-block fw-bold">${msg.sender_name === "admin" ? "管理员" : msg.sender_name}</small>
                                ${msg.content || ""}
                                ${msg.image_url ? `<img src="${fixImageUrl(msg.image_url)}" class="img-fluid mt-1" style="max-width: 150px; border-radius: 4px;">` : ""}
                                ${msg.video_url ? `<video controls class="mt-1" style="max-width: 150px;"><source src="${fixImageUrl(msg.video_url)}"></video>` : ""}
                                <small class="d-block text-muted mt-1">${new Date(msg.create_time).toLocaleString()}</small>
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="adminMessageInput" placeholder="输入回复..." onkeypress="if(event.key==='Enter') sendAdminMessage('${username}')">
                    <input type="file" id="adminFileInput" accept="image/*,video/*" style="display: none;" onchange="handleAdminFileUpload('${username}')">
                    <button class="btn btn-outline-secondary" onclick="document.getElementById('adminFileInput').click()" title="上传文件">
                        <i class="bi bi-paperclip"></i>
                    </button>
                    <button class="btn btn-primary" onclick="sendAdminMessage('${username}')">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            `;

        const container = document.getElementById("messagesContainer");
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      }

      async function sendAdminMessage(username) {
        const input = document.getElementById("adminMessageInput");
        const content = input.value.trim();

        if (!content) return;

        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(
            `${apiBaseUrl}/admin-chat/send`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("admin_token")}`,
              },
              body: JSON.stringify({
                sender_name: "admin",
                receiver_name: username,
                content: content,
              }),
            },
          );

          const result = await response.json();
          if (result.success) {
            input.value = "";
            // 重新加载当前用户的聊天记录
            loadUserChat(username);
          } else {
            alert("发送失败: " + result.error);
          }
        } catch (error) {
          console.error("发送消息失败:", error);
          alert("发送失败，请检查网络连接");
        }
      }

      function refreshChatUsers() {
        loadChatUsers();
      }
      
      // 自动刷新用户列表
      function autoRefreshUsers() {
        if (currentPage === 'chat') {
          loadChatUsers();
        }
      }
      
      // 每30秒自动刷新一次用户列表
      setInterval(autoRefreshUsers, 30030);
      
      async function loadAllMessages() {
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(
            `${apiBaseUrl}/admin-chat/messages`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("admin_token")}`,
              },
            },
          );
          const result = await response.json();

          if (result.success) {
            renderAllMessagesArea(result.data);
          } else {
            console.error("获取所有消息失败:", result.error);
          }
        } catch (error) {
          console.error("获取所有消息失败:", error);
        }
      }
      
      function renderAllMessagesArea(messages) {
        const chatArea = document.getElementById("chatArea");
        chatArea.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                    <h6 class="mb-0">所有聊天消息</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadAllMessages()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="flex-grow-1 overflow-auto mb-3" id="allMessagesContainer" style="max-height: 350px;">
                    ${messages.length === 0 ? 
                      '<div class="text-center text-muted p-4"><i class="bi bi-chat-dots" style="font-size: 2rem;"></i><p class="mt-2">暂无聊天消息</p></div>' :
                      messages
                      .map(
                        (msg) => `
                        <div class="mb-2 p-2 ${msg.sender_name === "admin" ? "text-end" : "text-start"}">
                            <div class="d-inline-block p-2 rounded ${msg.sender_name === "admin" ? "text-white" : "bg-light"}" style="max-width: 70%; background-color: ${msg.sender_name === "admin" ? "#B87333" : "#f8f9fa"};">
                                <small class="d-block fw-bold">${msg.sender_name === "admin" ? "管理员" : msg.sender_name}</small>
                                ${msg.content || ""}
                                ${msg.image_url ? `<img src="${fixImageUrl(msg.image_url)}" class="img-fluid mt-1" style="max-width: 150px; border-radius: 4px;">` : ""}
                                ${msg.video_url ? `<video controls class="mt-1" style="max-width: 150px;"><source src="${fixImageUrl(msg.video_url)}"></video>` : ""}
                                <small class="d-block text-muted mt-1">${new Date(msg.create_time).toLocaleString()}</small>
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="globalMessageInput" placeholder="发送全局消息..." onkeypress="if(event.key==='Enter') sendGlobalMessage()">
                    <button class="btn btn-primary" onclick="sendGlobalMessage()">
                        <i class="bi bi-send"></i> 全局发送
                    </button>
                </div>
            `;

        const container = document.getElementById("allMessagesContainer");
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      }
      
      async function sendGlobalMessage() {
        const input = document.getElementById("globalMessageInput");
        const content = input.value.trim();

        if (!content) return;

        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(
            `${apiBaseUrl}/admin-chat/send`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("admin_token")}`,
              },
              body: JSON.stringify({
                sender_name: "admin",
                receiver_name: "all",
                content: content,
              }),
            },
          );

          const result = await response.json();
          if (result.success) {
            input.value = "";
            loadAllMessages(); // 刷新消息列表
          } else {
            alert("发送失败: " + result.error);
          }
        } catch (error) {
          console.error("发送全局消息失败:", error);
          alert("发送失败，请检查网络连接");
        }
      }
      
      function updateTableHeaders(page) {
        const header3 = document.getElementById('dynamicHeader3');
        const header4 = document.getElementById('dynamicHeader4');
        
        if (header3 && header4) {
          if (page === 'carousel') {
            header3.textContent = '图片';
            header4.textContent = '状态';
          } else {
            header3.textContent = '类型';
            header4.textContent = '状态';
          }
        }
      }
      
      async function handleAdminFileUpload(username) {
        const fileInput = document.getElementById('adminFileInput');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        if (file.size > 10 * 1024 * 1024) {
          alert('文件大小不能超过10MB');
          return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('sender_name', 'admin');
        formData.append('receiver_name', username);
        
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(`${apiBaseUrl}/admin-chat/upload`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
            },
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            fileInput.value = '';
            loadUserChat(username);
          } else {
            alert('上传失败: ' + result.error);
          }
        } catch (error) {
          console.error('上传文件失败:', error);
          alert('上传失败，请检查网络连接');
        }
      }
      
      // 管理员管理函数
      async function addAdminItem() {
        const username = document.getElementById('addAdminUsername').value;
        const password = document.getElementById('addAdminPassword').value;
        const role = document.getElementById('addAdminRole').value;
        
        if (!username || !password) {
          alert('请填写管理员名和密码');
          return;
        }
        
        if (username.length < 3 || username.length > 50) {
          alert('管理员名长度必须在3-50个字符之间');
          return;
        }
        
        if (password.length < 6) {
          alert('密码长度不能少于6位');
          return;
        }
        
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(`${apiBaseUrl}/admin/admin`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('admin_token') || ''}`
            },
            body: JSON.stringify({
              username: username,
              password: password,
              role: role
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
            loadPageData(currentPage);
            alert('管理员添加成功');
          } else {
            alert('添加失败: ' + result.error);
          }
        } catch (error) {
          console.error('添加管理员失败:', error);
          alert('添加失败: ' + error.message);
        }
      }
      
      // 密码可见性切换
      function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const eyeIcon = document.getElementById(inputId + '-eye');
        
        if (input.type === 'password') {
          input.type = 'text';
          eyeIcon.className = 'bi bi-eye-slash';
        } else {
          input.type = 'password';
          eyeIcon.className = 'bi bi-eye';
        }
      }

      // 修改当前用户密码 - 使用模态框
      function changePassword() {
        // 清空管理员ID（表示修改当前用户密码）
        document.getElementById('changePasswordAdminId').value = '';
        
        // 重置表单
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('passwordStrength').innerHTML = '';
        document.getElementById('passwordMatch').style.display = 'none';
        
        // 恢复模态框标题
        document.getElementById('changePasswordModalLabel').textContent = '修改管理员密码';
        
        // 显示当前密码字段
        const currentPasswordGroup = document.getElementById('currentPassword').closest('.mb-3');
        currentPasswordGroup.style.display = 'block';
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
        modal.show();
      }
      
      // 确认修改密码
      async function confirmChangePassword() {
        const adminId = document.getElementById('changePasswordAdminId').value;
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // 表单验证
        if (!adminId && !currentPassword) {
          alert('请输入当前密码');
          return;
        }
        
        if (!newPassword) {
          alert('请输入新密码');
          return;
        }
        
        // 密码强度检查
        const strength = checkPasswordStrength(newPassword);
        if (strength < 2) {
          alert('密码强度不足，请使用更复杂的密码');
          return;
        }
        
        if (newPassword !== confirmPassword) {
          alert('两次输入的新密码不一致');
          return;
        }
        
        try {
          const apiBaseUrl = getApiBaseUrl();
          let response;
          
          if (adminId) {
            // 修改其他管理员密码
            response = await fetch(`${apiBaseUrl}/admin/admin/${adminId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('admin_token') || ''}`
              },
              body: JSON.stringify({
                password: newPassword
              })
            });
          } else {
            // 修改当前用户密码
            response = await fetch(`${apiBaseUrl}/admin/update-password`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('admin_token') || ''}`
              },
              body: JSON.stringify({
                currentPassword: currentPassword,
                newPassword: newPassword
              })
            });
          }
          
          const result = await response.json();
          
          if (result.success) {
            // 关闭模态框
            bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
            
            if (adminId) {
              // 修改其他管理员密码成功
              alert('管理员密码修改成功');
              loadPageData(currentPage); // 刷新页面数据
            } else {
              // 修改当前用户密码成功
              alert('密码修改成功，请重新登录');
              // 清除登录信息并跳转到登录页面
              localStorage.removeItem('admin_token');
              localStorage.removeItem('admin_user');
              localStorage.removeItem('admin_role');
              window.location.href = '../user-web/登录页面.html';
            }
          } else {
            alert('密码修改失败: ' + (result.error || result.message || '未知错误'));
          }
        } catch (error) {
          console.error('修改密码失败:', error);
          alert('修改密码失败: ' + error.message);
        }
      }
      
      // 检查密码强度
      function checkPasswordStrength(password) {
        let strength = 0;
        const strengthEl = document.getElementById('passwordStrength');
        
        // 重置强度显示
        strengthEl.innerHTML = '';
        
        if (password.length < 6) {
          strengthEl.innerHTML = '<span class="text-danger">密码长度至少6位</span>';
          return 0;
        }
        
        // 长度检查
        if (password.length >= 8) strength++;
        
        // 复杂度检查
        if (/[A-Z]/.test(password)) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        
        // 显示强度
        let strengthText = '';
        let strengthColor = '';
        
        if (strength <= 2) {
          strengthText = '弱';
          strengthColor = 'text-danger';
        } else if (strength <= 4) {
          strengthText = '中';
          strengthColor = 'text-warning';
        } else {
          strengthText = '强';
          strengthColor = 'text-success';
        }
        
        strengthEl.innerHTML = `<span class="${strengthColor}">密码强度: ${strengthText}</span>`;
        return strength;
      }
      
      // 监听密码输入，实时检查密码强度
      function setupPasswordListeners() {
        const newPassword = document.getElementById('newPassword');
        const confirmPassword = document.getElementById('confirmPassword');
        const passwordMatch = document.getElementById('passwordMatch');
        
        if (newPassword) {
          newPassword.addEventListener('input', function() {
            checkPasswordStrength(this.value);
            
            // 检查密码是否匹配
            if (confirmPassword.value) {
              checkPasswordMatch();
            }
          });
        }
        
        if (confirmPassword) {
          confirmPassword.addEventListener('input', checkPasswordMatch);
        }
      }
      
      // 检查两次输入的密码是否匹配
      function checkPasswordMatch() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const passwordMatch = document.getElementById('passwordMatch');
        
        if (!newPassword || !confirmPassword) {
          passwordMatch.style.display = 'none';
          return;
        }
        
        passwordMatch.style.display = 'block';
        
        if (newPassword === confirmPassword) {
          passwordMatch.innerHTML = '<span class="text-success">✓ 密码匹配</span>';
          return true;
        } else {
          passwordMatch.innerHTML = '<span class="text-danger">✗ 密码不匹配</span>';
          return false;
        }
      }
      
      // 在DOM加载完成后设置监听
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupPasswordListeners);
      } else {
        setupPasswordListeners();
      }
      
      // 修改其他管理员密码 - 使用统一的密码修改表单
      function changeAdminPassword(id) {
        // 设置管理员ID到隐藏字段
        document.getElementById('changePasswordAdminId').value = id;
        
        // 重置表单
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('passwordStrength').innerHTML = '';
        document.getElementById('passwordMatch').style.display = 'none';
        
        // 修改模态框标题为管理员密码修改
        document.getElementById('changePasswordModalLabel').textContent = '修改管理员密码';
        
        // 隐藏当前密码字段（管理员修改其他管理员密码不需要输入当前密码）
        const currentPasswordGroup = document.getElementById('currentPassword').closest('.mb-3');
        currentPasswordGroup.style.display = 'none';
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
        modal.show();
      }

      
      // 编辑管理员信息
      async function editAdmin(id) {
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(`${apiBaseUrl}/admin/admin/${id}`, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('admin_token') || ''}`
            }
          });
          
          const result = await response.json();
          
          if (result.success) {
            showEditAdminModal(result.data, id);
          } else {
            alert('获取管理员信息失败: ' + result.error);
          }
        } catch (error) {
          console.error('获取管理员信息失败:', error);
          alert('获取管理员信息失败: ' + error.message);
        }
      }
      
      // 显示编辑管理员模态框
      function showEditAdminModal(admin, id) {
        const existingModal = document.getElementById('editAdminModal');
        if (existingModal) {
          existingModal.remove();
        }
        
        const modal = document.createElement('div');
        modal.innerHTML = `
          <div class="modal fade" id="editAdminModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                  <h5 class="modal-title">
                    <i class="bi bi-pencil-square me-2"></i>编辑管理员
                  </h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <form id="editAdminForm">
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="bi bi-person me-1"></i>管理员名 *
                      </label>
                      <input type="text" class="form-control" id="editAdminUsername" value="${admin.username}" required>
                      <div class="form-text">用于登录的用户名，3-50个字符</div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="bi bi-shield-check me-1"></i>管理员类型
                      </label>
                      <select class="form-control" id="editAdminRole">
                        <option value="admin" ${admin.role === 'admin' ? 'selected' : ''}>普通管理员</option>
                        <option value="super_admin" ${admin.role === 'super_admin' ? 'selected' : ''}>超级管理员</option>
                      </select>
                    </div>
                    <div class="alert alert-info">
                      <i class="bi bi-info-circle me-2"></i>
                      <strong>提示：</strong>如需修改密码，请使用“改密码”按钮。
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i>取消
                  </button>
                  <button type="button" class="btn btn-primary" onclick="updateAdminInfo(${id})">
                    <i class="bi bi-check-lg me-1"></i>保存修改
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        const modalEl = new bootstrap.Modal(document.getElementById('editAdminModal'));
        modalEl.show();
      }
      
      // 更新管理员信息
      async function updateAdminInfo(id) {
        const username = document.getElementById('editAdminUsername').value;
        const role = document.getElementById('editAdminRole').value;
        
        if (!username) {
          alert('请输入管理员名');
          return;
        }
        
        if (username.length < 3 || username.length > 50) {
          alert('管理员名长度必须在3-50个字符之间');
          return;
        }
        
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(`${apiBaseUrl}/admin/admin/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('admin_token') || ''}`
            },
            body: JSON.stringify({
              username: username,
              role: role
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('editAdminModal')).hide();
            loadPageData(currentPage);
            alert('管理员信息更新成功');
          } else {
            alert('更新失败: ' + result.error);
          }
        } catch (error) {
          console.error('更新管理员信息失败:', error);
          alert('更新失败: ' + error.message);
        }
      }
      
      async function updateAdminPassword(id, newPassword) {
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(`${apiBaseUrl}/admin/admin/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('admin_token') || ''}`
            },
            body: JSON.stringify({
              password: newPassword
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('密码修改成功');
          } else {
            alert('密码修改失败: ' + result.error);
          }
        } catch (error) {
          console.error('修改密码失败:', error);
          alert('修改密码失败: ' + error.message);
        }
      }

      function renderTable(data, page) {
        const tbody = document.getElementById("contentTableBody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center py-5"><div class="d-flex flex-column align-items-center"><i class="bi bi-inbox" style="font-size: 3rem; color: var(--accent-color);"></i><h5 class="mt-3" style="color: var(--text-secondary);">暂无祈愿记录</h5><p class="text-muted">人间暂无祈愿，天官清闲</p></div></td></tr>';
          return;
        }

        data.forEach((item) => {
          const row = document.createElement("tr");
          if (page === "messages") {
            const contentPreview = item.content
              ? item.content.length > 30
                ? item.content.substring(0, 30) + "..."
                : item.content
              : "无内容";
            const replyStatus = item.reply ? "已回复" : "未回复";
            const replyBadge = item.reply
              ? '<span class="badge bg-success ms-1">已回复</span>'
              : '<span class="badge bg-warning ms-1">未回复</span>';
            const statusBadge =
              item.status === "published"
                ? '<span class="badge bg-success">已发布</span>'
                : item.status === "hidden"
                  ? '<span class="badge bg-danger">已隐藏</span>'
                  : '<span class="badge bg-warning">待审核</span>';

            row.innerHTML = `
                        <td><input type="checkbox" class="item-checkbox" value="${item.id}" onchange="updateDeleteButton()"></td>
                        <td>${item.id}</td>
                        <td title="${item.content || ""}">${contentPreview}</td>
                        <td>用户: ${item.username}<br/>邮箱: ${item.email || "未提供"}<br/>手机: ${item.phone || "未提供"} ${replyBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${formatDate(item.create_time)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="replyMessage(${item.id})" title="查看详情并回复">
                                <i class="bi bi-reply"></i> 回复
                            </button>
                            ${
                              item.status !== "published"
                                ? `<button class="btn btn-sm btn-success" onclick="approveMessage(${item.id})" title="发布留言">
                                <i class="bi bi-check"></i> 发布
                            </button>`
                                : ""
                            }
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id}, 'message')" title="删除留言">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </td>
                    `;
          } else if (page === "reviews") {
            const statusBadge =
              item.status === "approved"
                ? '<span class="badge bg-success">已审核</span>'
                : item.status === "rejected"
                  ? '<span class="badge bg-danger">已拒绝</span>'
                  : '<span class="badge bg-warning">待审核</span>';
            const contentPreview = item.content
              ? item.content.length > 50
                ? item.content.substring(0, 50) + "..."
                : item.content
              : "无内容";

            row.innerHTML = `
                        <td><input type="checkbox" class="item-checkbox" value="${item.id}" onchange="updateDeleteButton()"></td>
                        <td>${item.id}</td>
                        <td title="${item.content || ""}">${contentPreview}</td>
                        <td>用户: ${item.username} (${item.rating}/5星)</td>
                        <td>${statusBadge}</td>
                        <td>${formatDate(item.create_time)}</td>
                        <td>
                            ${item.status === "pending" ? `<button class="btn btn-sm btn-success" onclick="approveReview(${item.id})" title="通过审核">通过</button>` : ""}
                            ${item.status === "pending" ? `<button class="btn btn-sm btn-warning" onclick="rejectReview(${item.id})" title="拒绝审核">拒绝</button>` : ""}
                            <button class="btn btn-sm btn-info" onclick="viewReview(${item.id})" title="查看详情">查看</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id}, 'reviews')" title="删除评价">删除</button>
                        </td>
                    `;
          } else if (page === "quotes") {
            const contentPreview = item.content
              ? item.content.length > 50
                ? item.content.substring(0, 50) + "..."
                : item.content
              : "无内容";

            row.innerHTML = `
                        <td><input type="checkbox" class="item-checkbox" value="${item.id}" onchange="updateDeleteButton()"></td>
                        <td>${item.id}</td>
                        <td title="${item.content || ""}">${contentPreview}</td>
                        <td>${item.character_name}</td>
                        <td>${item.status}</td>
                        <td>${formatDate(item.create_time)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editItem(${item.id})">编辑</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id}, 'quotes')">删除</button>
                        </td>
                    `;
          } else if (page === "admins") {
            row.innerHTML = `
                        <td><input type="checkbox" class="item-checkbox" value="${item.id}" onchange="updateDeleteButton()"></td>
                        <td>${item.id}</td>
                        <td>${item.username}</td>
                        <td>管理员</td>
                        <td>${item.role === "super_admin" ? "超级管理员" : "管理员"}</td>
                        <td>${formatDate(item.create_time)}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editAdmin(${item.id})">编辑</button>
                            <button class="btn btn-sm btn-warning" onclick="changeAdminPassword(${item.id})">改密码</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id}, 'admins')">删除</button>
                        </td>
                    `;
          } else if (page === "Basic_Information") {
            row.innerHTML = `
                        <td><input type="checkbox" class="item-checkbox" value="${item.id}" onchange="updateDeleteButton()"></td>
                        <td>${item.id}</td>
                        <td>${item.label}</td>
                        <td>基本信息</td>
                        <td>已发布</td>
                        <td>${formatDate(item.create_time)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editBasicInfo(${item.id})">编辑</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id}, 'Basic_Information')">删除</button>
                        </td>
                    `;
          } else if (page === "carousel") {
            row.innerHTML = `
                        <td><input type="checkbox" class="item-checkbox" value="${item.id}" onchange="updateDeleteButton()"></td>
                        <td>${item.id}</td>
                        <td>${item.title}</td>
                        <td><img src="${fixImageUrl(item.image_url)}" alt="轮播图" style="width: 60px; height: 40px; object-fit: cover;"></td>
                        <td><span class="badge ${item.is_active ? 'bg-success' : 'bg-secondary'}">${item.is_active ? '启用' : '禁用'}</span></td>
                        <td>${formatDate(item.create_time)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editCarousel(${item.id})">编辑</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCarousel(${item.id})">删除</button>
                        </td>
                    `;
          } else {
            row.innerHTML = `
                        <td><input type="checkbox" class="item-checkbox" value="${item.id}" onchange="updateDeleteButton()"></td>
                        <td>${item.id}</td>
                        <td>${item.title || item.name}</td>
                        <td>${getTypeLabel(page)}</td>
                        <td>${item.status}</td>
                        <td>${formatDate(item.create_time)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editItem(${item.id})">编辑</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id}, '${page}')">删除</button>
                        </td>
                    `;
          }
          tbody.appendChild(row);
        });
      }

      function getTypeLabel(page) {
        const labels = {
          home: "首页内容",
          characters: "角色信息",
          story: "剧情简介",
          reviews: "作品评价",
          messages: "用户留言",
        };
        return labels[page] || page;
      }

      function formatDate(dateString) {
        if (!dateString) return "-";
        return new Date(dateString).toLocaleString("zh-CN");
      }

      function showError(message) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "alert alert-warning mt-3 error-toast";
        errorDiv.textContent = message;
        document.body.appendChild(errorDiv);

        setTimeout(() => {
          if (document.body.contains(errorDiv)) {
            document.body.removeChild(errorDiv);
          }
        }, 3003);
      }

      function showAddModal() {
        // 清理已存在的模态框
        const existingModal = document.getElementById("addModal");
        if (existingModal) {
          existingModal.remove();
        }

        const modal = document.createElement("div");

        if (currentPage === "home") {
          modal.innerHTML = `
                    <div class="modal fade" id="addModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                                    <h5 class="modal-title">
                                        <i class="bi bi-house-add me-2"></i>添加首页内容
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addHomeForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-card-text me-1"></i>内容标题 *
                                                    </label>
                                                    <input type="text" class="form-control" id="addTitle" required placeholder="例如：天官赐福简介">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-image me-1"></i>配图地址
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="addImageUrl" placeholder="../img/home-banner.jpg">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('addHomeImageFile').click()">
                                                            <i class="bi bi-upload"></i> 上传
                                                        </button>
                                                    </div>
                                                    <input type="file" id="addHomeImageFile" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'addImageUrl')">
                                                    <div id="addHomeImagePreview" class="mt-2" style="display: none;">
                                                        <img id="addHomePreviewImg" src="" alt="预览" style="max-width: 200px; max-height: 100px; border-radius: 4px;">
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-link-45deg me-1"></i>链接地址
                                                    </label>
                                                    <input type="url" class="form-control" id="addLinkUrl" placeholder="/user-web/页面.html">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-file-text me-1"></i>内容描述 *
                                                    </label>
                                                    <textarea class="form-control" id="addContent" rows="6" required placeholder="请输入首页内容的详细描述"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-sort-numeric-down me-1"></i>显示顺序
                                                    </label>
                                                    <input type="number" class="form-control" id="addDisplayOrder" value="1" min="1">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-toggle-on me-1"></i>发布状态
                                                    </label>
                                                    <select class="form-control" id="addStatus">
                                                        <option value="published">✅ 已发布</option>
                                                        <option value="draft">📝 草稿</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>提示：</strong>首页内容将在网站首页展示，但只展示前三条，请确保内容准确且吸引人。
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-lg me-1"></i>取消
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="addItem()">
                                        <i class="bi bi-check-lg me-1"></i>保存内容
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        } else if (currentPage === "characters") {
          modal.innerHTML = `
                    <div class="modal fade" id="addModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                                    <h5 class="modal-title">
                                        <i class="bi bi-person-plus me-2"></i>添加角色信息
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addCharacterForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-person me-1"></i>角色名称 *
                                                    </label>
                                                    <input type="text" class="form-control" id="addTitle" required placeholder="例如：谢怜">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-image me-1"></i>角色头像 *
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="addImage" placeholder="../img/谢怜.jpg" onblur="validateImageUrl(this)">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('addCharacterImageFile').click()">
                                                            <i class="bi bi-upload"></i> 上传
                                                        </button>
                                                    </div>
                                                    <input type="file" id="addCharacterImageFile" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'addImage')">
                                                    <div class="form-text">支持JPG、PNG、GIF格式，建议尺寸300x300像素</div>
                                                    <div id="addCharacterImagePreview" class="mt-2" style="display: none;">
                                                        <img id="addCharacterPreviewImg" src="" alt="预览" style="max-width: 150px; max-height: 150px; border-radius: 8px; border: 2px solid #deb887;">
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-star me-1"></i>角色重要性
                                                    </label>
                                                    <select class="form-control" id="addRoleImportance">
                                                        <option value="main">🌟 主角</option>
                                                        <option value="supporting">⭐ 配角</option>
                                                        <option value="minor">✨ 次要角色</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-chat-text me-1"></i>角色简介 *
                                                    </label>
                                                    <textarea class="form-control" id="addContent" rows="4" required placeholder="请输入角色的基本介绍"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-heart me-1"></i>性格特点
                                                    </label>
                                                    <textarea class="form-control" id="addPersonality" rows="3" placeholder="描述角色的性格特征"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-sort-numeric-down me-1"></i>显示顺序
                                                    </label>
                                                    <input type="number" class="form-control" id="addDisplayOrder" value="1" min="1">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-toggle-on me-1"></i>发布状态
                                                    </label>
                                                    <select class="form-control" id="addStatus">
                                                        <option value="published">✅ 已发布</option>
                                                        <option value="draft">📝 草稿</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>提示：</strong>角色信息将在角色介绍页面展示，请确保信息准确完整。
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-lg me-1"></i>取消
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="addItem()">
                                        <i class="bi bi-check-lg me-1"></i>保存角色
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        } else if (currentPage === "story") {
          modal.innerHTML = `
                    <div class="modal fade" id="addModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                                    <h5 class="modal-title">
                                        <i class="bi bi-book-half me-2"></i>添加剧情简介
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addStoryForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-card-heading me-1"></i>章节标题 *
                                                    </label>
                                                    <input type="text" class="form-control" id="addTitle" required placeholder="例如：第一章 初遇">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-hash me-1"></i>章节编号
                                                    </label>
                                                    <input type="text" class="form-control" id="addChapterNumber" placeholder="例如：001">
                                                    <div class="form-text">用于排序和组织章节</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-sort-numeric-down me-1"></i>显示顺序
                                                    </label>
                                                    <input type="number" class="form-control" id="addDisplayOrder" value="1" min="1">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-toggle-on me-1"></i>发布状态
                                                    </label>
                                                    <select class="form-control" id="addStatus">
                                                        <option value="published">✅ 已发布</option>
                                                        <option value="draft">📝 草稿</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-file-text me-1"></i>剧情内容 *
                                                    </label>
                                                    <textarea class="form-control" id="addContent" rows="10" required placeholder="请输入该章节的剧情简介内容"></textarea>
                                                    <div class="form-text">支持多行文本，可以包含段落分隔</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="alert alert-info">
                                                    <i class="bi bi-info-circle me-2"></i>
                                                    <strong>提示：</strong>剧情简介将在前台页面中展示，请确保内容精彩且不包含剧透。
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-lg me-1"></i>取消
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="addItem()">
                                        <i class="bi bi-check-lg me-1"></i>保存章节
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        } else if (currentPage === "reviews") {
          modal.innerHTML = `
                    <div class="modal fade" id="addModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                                    <h5 class="modal-title">
                                        <i class="bi bi-star-fill me-2"></i>添加作品评价
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addReviewForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-person me-1"></i>读者名称 *
                                                    </label>
                                                    <input type="text" class="form-control" id="addTitle" required placeholder="例如：书迷小明">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-star me-1"></i>评分等级 *
                                                    </label>
                                                    <select class="form-control" id="addRating">
                                                        <option value="5">⭐⭐⭐⭐⭐ 5星（非常好）</option>
                                                        <option value="4">⭐⭐⭐⭐☆ 4星（好）</option>
                                                        <option value="3">⭐⭐⭐☆☆ 3星（一般）</option>
                                                        <option value="2">⭐⭐☆☆☆ 2星（较差）</option>
                                                        <option value="1">⭐☆☆☆☆ 1星（很差）</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-calendar-event me-1"></i>评价日期
                                                    </label>
                                                    <input type="date" class="form-control" id="addReviewDate" value="${new Date().toISOString().split('T')[0]}">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-toggle-on me-1"></i>审核状态
                                                    </label>
                                                    <select class="form-control" id="addStatus">
                                                        <option value="approved">✅ 已审核</option>
                                                        <option value="pending">⏳ 待审核</option>
                                                        <option value="rejected">❌ 已拒绝</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-chat-text me-1"></i>评价内容 *
                                                    </label>
                                                    <textarea class="form-control" id="addContent" rows="8" required placeholder="请输入详细的评价内容，分享您的阅读感受"></textarea>
                                                    <div class="form-text">建议包含对作品的具体评价和推荐理由</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-tags me-1"></i>评价标签
                                                    </label>
                                                    <div class="d-flex flex-wrap gap-2">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="tagPlot" value="剧情">
                                                            <label class="form-check-label" for="tagPlot">剧情精彩</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="tagCharacter" value="人物">
                                                            <label class="form-check-label" for="tagCharacter">人物生动</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="tagWriting" value="文笔">
                                                            <label class="form-check-label" for="tagWriting">文笔优美</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="tagEmotion" value="情感">
                                                            <label class="form-check-label" for="tagEmotion">情感丰富</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>提示：</strong>作品评价将在首页展示，请确保内容积极正面且符合社区规范。
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-lg me-1"></i>取消
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="addItem()">
                                        <i class="bi bi-check-lg me-1"></i>保存评价
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        } else if (currentPage === "quotes") {
          modal.innerHTML = `
                    <div class="modal fade" id="addModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                                    <h5 class="modal-title">
                                        <i class="bi bi-chat-quote me-2"></i>添加人物语录
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addQuoteForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-person me-1"></i>人物名称 *
                                                    </label>
                                                    <select class="form-control" id="addCharacterName" required>
                                                        <option value="">请选择人物</option>
                                                        <option value="🌟 谢怜">🌟 谢怜</option>
                                                        <option value="🔥 花城">🔥 花城</option>
                                                        <option value="📿 君吾">📿 君吾</option>
                                                        <option value="🦋 师青玄">🦋 师青玄</option>
                                                        <option value="💧 贺玄">💧 贺玄</option>
                                                        <option value="🦊 风信">🦊 风信</option>
                                                        <option value="🐶 慕情">🐶 慕情</option>
                                                    </select>
                                                    <div class="form-text">或者手动输入新人物</div>
                                                    <input type="text" class="form-control mt-2" id="addCustomCharacter" placeholder="手动输入人物名称">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-image me-1"></i>人物头像
                                                    </label>
                                                    <input type="text" class="form-control" id="addImage" placeholder="../img/人物名.jpg">
                                                    <div class="form-text">可选，用于展示人物头像</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-sort-numeric-down me-1"></i>显示顺序
                                                    </label>
                                                    <input type="number" class="form-control" id="addDisplayOrder" value="1" min="1">
                                                    <div class="form-text">数字越小显示越靠前</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-chat-text me-1"></i>语录内容 *
                                                    </label>
                                                    <textarea class="form-control" id="addContent" rows="8" required placeholder="请输入人物的经典语录，多条语录请用换行分隔"></textarea>
                                                    <div class="form-text">支持多行文本，每行一条语录</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-toggle-on me-1"></i>发布状态
                                                    </label>
                                                    <select class="form-control" id="addStatus">
                                                        <option value="published">✅ 已发布</option>
                                                        <option value="draft">📝 草稿</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="alert alert-info">
                                                    <i class="bi bi-info-circle me-2"></i>
                                                    <strong>提示：</strong>人物语录将在前台页面中展示，请确保内容准确且符合人物特色。
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-lg me-1"></i>取消
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="addQuoteItem()">
                                        <i class="bi bi-check-lg me-1"></i>保存语录
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        } else if (currentPage === "carousel") {
          modal.innerHTML = `
                    <div class="modal fade" id="addModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                                    <h5 class="modal-title">
                                        <i class="bi bi-images me-2"></i>添加轮播图
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addCarouselForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-card-text me-1"></i>轮播图标题 *
                                                    </label>
                                                    <input type="text" class="form-control" id="addTitle" required placeholder="请输入轮播图标题">
                                                    <div class="form-text">将显示在轮播图上的标题文字</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-image me-1"></i>图片地址 *
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="addImageUrl" required placeholder="../img/carousel1.jpg" onblur="validateImageUrl(this)">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('addImageFile').click()">
                                                            <i class="bi bi-upload"></i> 上传
                                                        </button>
                                                    </div>
                                                    <input type="file" id="addImageFile" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'addImageUrl')">
                                                    <div class="form-text">支持相对路径、绝对URL或上传图片</div>
                                                    <div id="addImagePreview" class="mt-2" style="display: none;">
                                                        <img id="addPreviewImg" src="" alt="预览" style="max-width: 200px; max-height: 100px; border-radius: 4px;">
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-link-45deg me-1"></i>点击链接
                                                    </label>
                                                    <input type="url" class="form-control" id="addLinkUrl" placeholder="/user-web/页面.html">
                                                    <div class="form-text">点击轮播图时跳转的链接，可为空</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-chat-text me-1"></i>轮播图描述
                                                    </label>
                                                    <textarea class="form-control" id="addDescription" rows="4" placeholder="请输入轮播图的详细描述"></textarea>
                                                    <div class="form-text">用于显示轮播图的详细信息</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-sort-numeric-down me-1"></i>显示顺序
                                                    </label>
                                                    <input type="number" class="form-control" id="addOrder" value="1" min="1">
                                                    <div class="form-text">数字越小显示越靠前</div>
                                                </div>
                                                <div class="mb-3">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="addActive" checked>
                                                        <label class="form-check-label" for="addActive">
                                                            <i class="bi bi-toggle-on me-1"></i>启用轮播图
                                                        </label>
                                                    </div>
                                                    <div class="form-text">只有启用的轮播图才会在前台显示</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="alert alert-info">
                                                    <i class="bi bi-info-circle me-2"></i>
                                                    <strong>提示：</strong>轮播图将在首页显示，建议使用高质量图片，尺寸为 1200x400 像素。
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-lg me-1"></i>取消
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="addCarouselItem()">
                                        <i class="bi bi-check-lg me-1"></i>保存轮播图
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        } else if (currentPage === "admins") {
          modal.innerHTML = `
                    <div class="modal fade" id="addModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                                    <h5 class="modal-title">
                                        <i class="bi bi-person-plus me-2"></i>添加管理员
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addAdminForm">
                                        <div class="mb-3">
                                            <label class="form-label">
                                                <i class="bi bi-person me-1"></i>管理员名 *
                                            </label>
                                            <input type="text" class="form-control" id="addAdminUsername" required placeholder="请输入管理员名">
                                            <div class="form-text">用于登录的用户名，3-50个字符</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">
                                                <i class="bi bi-lock me-1"></i>登录密码 *
                                            </label>
                                            <div class="password-input-wrapper">
                                                <input type="password" class="form-control" id="addAdminPassword" required placeholder="请输入密码">
                                                <button type="button" class="password-toggle" onclick="togglePassword('addAdminPassword')">
                                                    <i class="bi bi-eye" id="addAdminPassword-eye"></i>
                                                </button>
                                            </div>
                                            <div class="form-text">密码长度不少于6位</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">
                                                <i class="bi bi-shield-check me-1"></i>管理员类型
                                            </label>
                                            <select class="form-control" id="addAdminRole">
                                                <option value="admin">普通管理员</option>
                                                <option value="super_admin">超级管理员</option>
                                            </select>
                                        </div>
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            <strong>注意：</strong>请妥善保管管理员账号信息，避免泄露。
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-lg me-1"></i>取消
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="addAdminItem()">
                                        <i class="bi bi-check-lg me-1"></i>添加管理员
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        } else if (currentPage === "Basic_Information") {
          modal.innerHTML = `
                    <div class="modal fade" id="addModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                                    <h5 class="modal-title">
                                        <i class="bi bi-info-circle me-2"></i>添加基本信息
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addBasicInfoForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-tag me-1"></i>信息类型 *
                                                    </label>
                                                    <select class="form-control" id="addInfoType" required onchange="updateBasicInfoFields()">
                                                        <option value="">请选择信息类型</option>
                                                        <option value="work">作品信息</option>
                                                        <option value="author">作者信息</option>
                                                        <option value="publish">出版信息</option>
                                                        <option value="stats">统计信息</option>
                                                        <option value="custom">自定义信息</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-bookmark me-1"></i>标签名称 *
                                                    </label>
                                                    <input type="text" class="form-control" id="addTitle" required placeholder="例如：作品名称">
                                                    <div class="form-text">将显示在前台页面的标签</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-sort-numeric-down me-1"></i>显示顺序
                                                    </label>
                                                    <input type="number" class="form-control" id="addDisplayOrder" value="0" min="0">
                                                    <div class="form-text">数字越小显示越靠前</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-file-text me-1"></i>内容值 *
                                                    </label>
                                                    <textarea class="form-control" id="addContent" rows="4" required placeholder="例如：天官赐福"></textarea>
                                                    <div class="form-text">支持多行文本</div>
                                                </div>
                                                <div class="mb-3" id="quickFillSection" style="display: none;">
                                                    <label class="form-label">
                                                        <i class="bi bi-lightning me-1"></i>快速填充
                                                    </label>
                                                    <div id="quickFillButtons"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="alert alert-info">
                                                    <i class="bi bi-info-circle me-2"></i>
                                                    <strong>提示：</strong>基本信息将在前台页面中展示，请确保内容准确。
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-lg me-1"></i>取消
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="addBasicInfoItem()">
                                        <i class="bi bi-check-lg me-1"></i>保存信息
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        } else if (currentPage === "story") {
          modal.innerHTML = `
                    <div class="modal fade" id="addModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                                    <h5 class="modal-title">
                                        <i class="bi bi-book me-2"></i>添加剧情简介
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addStoryForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-card-text me-1"></i>章节标题 *
                                                    </label>
                                                    <input type="text" class="form-control" id="addTitle" required placeholder="例如：第1章 神武大街">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-hash me-1"></i>章节编号
                                                    </label>
                                                    <input type="number" class="form-control" id="addChapterNumber" value="0" min="0">
                                                    <div class="form-text">章节序号，0表示序章</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-sort-numeric-down me-1"></i>显示顺序
                                                    </label>
                                                    <input type="number" class="form-control" id="addDisplayOrder" value="1" min="1">
                                                    <div class="form-text">数字越小显示越靠前</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-chat-text me-1"></i>剧情简介 *
                                                    </label>
                                                    <textarea class="form-control" id="addContent" rows="8" required placeholder="请输入本章节的剧情简介"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-toggle-on me-1"></i>发布状态
                                                    </label>
                                                    <select class="form-control" id="addStatus">
                                                        <option value="published">✅ 已发布</option>
                                                        <option value="draft">📝 草稿</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>提示：</strong>剧情简介将在前台页面中展示，请确保内容准确且符合章节顺序。
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-lg me-1"></i>取消
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="addItem()">
                                        <i class="bi bi-check-lg me-1"></i>保存简介
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        } else if (currentPage === "messages") {
          modal.innerHTML = `
                    <div class="modal fade" id="addModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                                    <h5 class="modal-title">
                                        <i class="bi bi-chat-dots me-2"></i>添加留言信息
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addMessageForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-person me-1"></i>用户名称 *
                                                    </label>
                                                    <input type="text" class="form-control" id="addTitle" required placeholder="例如：粉丝小明">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-envelope me-1"></i>联系邮箱
                                                    </label>
                                                    <input type="email" class="form-control" id="addEmail" placeholder="user@example.com">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-telephone me-1"></i>联系电话
                                                    </label>
                                                    <input type="tel" class="form-control" id="addPhone" placeholder="138****8888">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-toggle-on me-1"></i>留言状态
                                                    </label>
                                                    <select class="form-control" id="addStatus">
                                                        <option value="published">✅ 已发布</option>
                                                        <option value="pending">⏳ 待审核</option>
                                                        <option value="hidden">🙈 已隐藏</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-chat-text me-1"></i>留言内容 *
                                                    </label>
                                                    <textarea class="form-control" id="addContent" rows="6" required placeholder="请输入留言内容"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-reply me-1"></i>管理员回复
                                                    </label>
                                                    <textarea class="form-control" id="addReply" rows="3" placeholder="可选：管理员回复内容"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>提示：</strong>留言将在留言板页面展示，请确保内容健康积极。
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-lg me-1"></i>取消
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="addItem()">
                                        <i class="bi bi-check-lg me-1"></i>保存留言
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        } else {
          modal.innerHTML = `
                    <div class="modal fade" id="addModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">添加内容</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addForm">
                                        <div class="mb-3">
                                            <label class="form-label">标题/名称</label>
                                            <input type="text" class="form-control" id="addTitle" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">内容/描述</label>
                                            <textarea class="form-control" id="addContent" rows="3"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">状态</label>
                                            <select class="form-control" id="addStatus">
                                                <option value="published">已发布</option>
                                                <option value="draft">草稿</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="addItem()">保存</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }

        document.body.appendChild(modal);
        const modalEl = document.getElementById("addModal");
        const bootstrapModal = new bootstrap.Modal(modalEl);
        bootstrapModal.show();
      }

      async function addQuoteItem() {
        const selectedCharacter =
          document.getElementById("addCharacterName").value;
        const customCharacter =
          document.getElementById("addCustomCharacter").value;
        const content = document.getElementById("addContent").value;
        const image = document.getElementById("addImage").value;
        const displayOrder = document.getElementById("addDisplayOrder").value;
        const status = document.getElementById("addStatus").value;

        const characterName = customCharacter.trim() || selectedCharacter;

        if (!characterName) {
          alert("请选择或输入人物名称");
          return;
        }

        if (!content.trim()) {
          alert("请输入语录内容");
          return;
        }

        try {
          const data = {
            character_name: characterName,
            content: content.trim(),
            image_url: image || "",
            display_order: parseInt(displayOrder) || 1,
            status: status,
          };

          const response = await fetch(
            "/api/admin/quotes",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
              },
              body: JSON.stringify(data),
            },
          );

          const result = await response.json();

          if (result.success) {
            bootstrap.Modal.getInstance(
              document.getElementById("addModal"),
            ).hide();
            loadPageData(currentPage);
            alert("人物语录添加成功！");
          } else {
            alert("添加失败: " + (result.error || "未知错误"));
          }
        } catch (error) {
          alert("添加失败: " + error.message);
        }
      }

      function updateBasicInfoFields() {
        const infoType = document.getElementById("addInfoType").value;
        const quickFillSection = document.getElementById("quickFillSection");
        const quickFillButtons = document.getElementById("quickFillButtons");

        if (infoType && infoType !== "custom") {
          quickFillSection.style.display = "block";

          const templates = {
            work: [
              { label: "作品名称", value: "天官赐福" },
              { label: "作品别名", value: "纯情太子妖艳妃" },
              { label: "文学体裁", value: "小说" },
              { label: "类型", value: "原创-纯爱-架空历史-爱情" },
            ],
            author: [
              { label: "作者", value: "墨香铜臭" },
              { label: "主角", value: "谢怜、花城" },
            ],
            publish: [
              { label: "发表时间", value: "2017-06-16" },
              { label: "连载状态", value: "正文及番外均已完结" },
              { label: "连载平台", value: "晋江文学城" },
              { label: "出版状态", value: "已出版（全六册）" },
            ],
            stats: [
              { label: "全文字数", value: "1144742字" },
              { label: "最新章节", value: "第252章：鬼王的生辰" },
            ],
          };

          quickFillButtons.innerHTML = templates[infoType]
            .map(
              (item) =>
                `<button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="fillBasicInfo('${item.label}', '${item.value}')">${item.label}</button>`,
            )
            .join("");
        } else {
          quickFillSection.style.display = "none";
        }
      }

      function fillBasicInfo(label, value) {
        document.getElementById("addTitle").value = label;
        document.getElementById("addContent").value = value;
      }

      async function addBasicInfoItem() {
        const title = document.getElementById("addTitle").value;
        const content = document.getElementById("addContent").value;
        const displayOrder = document.getElementById("addDisplayOrder").value;

        if (!title || !content) {
          alert("请填写标签名称和内容值");
          return;
        }

        try {
          const apiBaseUrl = getApiBaseUrl();
          const data = {
            label: title,
            value: content,
            display_order: parseInt(displayOrder) || 0,
          };

          const response = await fetch(
            `${apiBaseUrl}/admin/basic-info`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
              },
              body: JSON.stringify(data),
            },
          );

          const result = await response.json();

          if (result.success) {
            bootstrap.Modal.getInstance(
              document.getElementById("addModal"),
            ).hide();
            loadPageData(currentPage);
            alert("基本信息添加成功！");
          } else {
            alert("添加失败: " + (result.error || "未知错误"));
          }
        } catch (error) {
          alert("添加失败: " + error.message);
        }
      }

      async function addItem() {
        const titleInput = document.getElementById("addTitle");
        const contentInput = document.getElementById("addContent");
        const statusInput = document.getElementById("addStatus");

        if (!titleInput || !contentInput || !statusInput) {
          alert("表单元素未找到，请刷新页面重试");
          return;
        }

        const title = titleInput.value;
        const content = contentInput.value;
        const status = statusInput.value;

        if (!title) {
          alert("请输入标题");
          return;
        }

        try {
          const apiBaseUrl = getApiBaseUrl();
          let apiUrl = "";
          let data = {};

          if (currentPage === "home") {
            const imageUrlInput = document.getElementById("addImageUrl");
            const linkUrlInput = document.getElementById("addLinkUrl");
            const displayOrderInput = document.getElementById("addDisplayOrder");
            
            apiUrl = `${apiBaseUrl}/admin/home-content`;
            data = {
              title,
              content,
              image_url: imageUrlInput ? imageUrlInput.value : "",
              link_url: linkUrlInput ? linkUrlInput.value : "",
              display_order: displayOrderInput ? parseInt(displayOrderInput.value) || 1 : 1,
              status
            };
          } else if (currentPage === "characters") {
            const imageInput = document.getElementById("addImage");
            const personalityInput = document.getElementById("addPersonality");
            const roleImportanceInput = document.getElementById("addRoleImportance");
            const displayOrderInput = document.getElementById("addDisplayOrder");
            
            // 验证图片URL
            const imageUrl = imageInput ? imageInput.value : "";
            if (imageUrl && imageInput.classList.contains('is-invalid')) {
              alert("请输入有效的图片地址");
              return;
            }

            apiUrl = `${apiBaseUrl}/admin/character`;
            data = {
              name: title,
              description: content,
              image_url: imageUrl,
              personality: personalityInput ? personalityInput.value : "",
              role_importance: roleImportanceInput ? roleImportanceInput.value : "supporting",
              display_order: displayOrderInput ? parseInt(displayOrderInput.value) || 1 : 1,
              status,
            };
          } else if (currentPage === "story") {
            const chapterNumberInput = document.getElementById("addChapterNumber");
            const displayOrderInput = document.getElementById("addDisplayOrder");
            
            apiUrl = `${apiBaseUrl}/admin/story-intro`;
            data = {
              title,
              content,
              chapter_number: chapterNumberInput ? parseInt(chapterNumberInput.value) || 0 : 0,
              display_order: displayOrderInput ? parseInt(displayOrderInput.value) || 1 : 1,
              status
            };
          } else if (currentPage === "reviews") {
            const ratingInput = document.getElementById("addRating");
            const reviewDateInput = document.getElementById("addReviewDate");
            
            // 获取选中的标签
            const tags = [];
            const tagInputs = document.querySelectorAll('input[type="checkbox"]:checked');
            tagInputs.forEach(input => {
              tags.push(input.value);
            });

            apiUrl = `${apiBaseUrl}/admin/work-review`;
            data = {
              username: title,
              content: content,
              rating: ratingInput ? parseInt(ratingInput.value) || 5 : 5,
              review_date: reviewDateInput ? reviewDateInput.value : new Date().toISOString().split('T')[0],
              tags: tags.join(','),
              status,
            };
          } else if (currentPage === "messages") {
            const emailInput = document.getElementById("addEmail");
            const phoneInput = document.getElementById("addPhone");
            const replyInput = document.getElementById("addReply");
            
            apiUrl = `${apiBaseUrl}/admin/message`;
            data = {
              username: title,
              content: content,
              email: emailInput ? emailInput.value : "",
              phone: phoneInput ? phoneInput.value : "",
              reply: replyInput ? replyInput.value : "",
              status
            };
          } else if (currentPage === "quotes") {
            const imageInput = document.getElementById("addImage");
            const image = imageInput ? imageInput.value : "";

            apiUrl = `${apiBaseUrl}/admin/quotes`;
            data = {
              character_name: title,
              content: content,
              image_url: image,
              status,
            };
          } else if (currentPage === "Basic_Information") {
            const displayOrderInput =
              document.getElementById("addDisplayOrder");
            const displayOrder = displayOrderInput
              ? displayOrderInput.value
              : "0";

            apiUrl = `${apiBaseUrl}/admin/basic-info`;
            data = {
              label: title,
              value: content,
              display_order: parseInt(displayOrder) || 0,
            };
          } else {
            apiUrl = `${apiBaseUrl}/admin/home-content`;
            data = { title, content, status };
          }

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
            },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (result.success) {
            bootstrap.Modal.getInstance(
              document.getElementById("addModal"),
            ).hide();
            loadPageData(currentPage);
            alert("添加成功");
          } else {
            alert("添加失败: " + (result.error || "未知错误"));
          }
        } catch (error) {
          alert("添加失败: " + error.message);
        }
      }

      async function editItem(id) {
        try {
          const apiBaseUrl = getApiBaseUrl();
          let apiUrl = "";
          if (currentPage === "characters") {
            apiUrl = `${apiBaseUrl}/admin/character/${id}`;
          } else if (currentPage === "story") {
            apiUrl = `${apiBaseUrl}/admin/story-intro/${id}`;
          } else if (currentPage === "reviews") {
            apiUrl = `${apiBaseUrl}/admin/work-review/${id}`;
          } else if (currentPage === "messages") {
            apiUrl = `${apiBaseUrl}/admin/message/${id}`;
          } else if (currentPage === "quotes") {
            apiUrl = `${apiBaseUrl}/admin/quotes/${id}`;
          } else {
            apiUrl = `${apiBaseUrl}/admin/home-content/${id}`;
          }

          const response = await fetch(apiUrl, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
            },
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              showEditModal(result.data, id);
            } else {
              alert("获取数据失败: " + (result.error || "未知错误"));
            }
          } else {
            alert("获取数据失败");
          }
        } catch (error) {
          alert("获取数据失败: " + error.message);
        }
      }

      function showEditModal(data, id) {
        // 清理已存在的模态框
        const existingModal = document.getElementById("editModal");
        if (existingModal) {
          existingModal.remove();
        }

        const modal = document.createElement("div");

        if (currentPage === "characters") {
          modal.innerHTML = `
                    <div class="modal fade" id="editModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                                    <h5 class="modal-title">
                                        <i class="bi bi-pencil-square me-2"></i>编辑角色信息
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editCharacterForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-person me-1"></i>角色名称 *
                                                    </label>
                                                    <input type="text" class="form-control" id="editTitle" value="${data.name || ""}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-image me-1"></i>角色头像
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="editImage" value="${data.image_url || ""}" onblur="validateImageUrl(this)">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('editCharacterImageFile').click()">
                                                            <i class="bi bi-upload"></i> 上传
                                                        </button>
                                                    </div>
                                                    <input type="file" id="editCharacterImageFile" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'editImage')">
                                                    <div id="editCharacterImagePreview" class="mt-2" ${data.image_url ? '' : 'style="display: none;"'}>
                                                        <img id="editCharacterPreviewImg" src="${data.image_url || ''}" alt="预览" style="max-width: 150px; max-height: 150px; border-radius: 8px; border: 2px solid #deb887;" onerror="this.parentElement.style.display='none'">
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-star me-1"></i>角色重要性
                                                    </label>
                                                    <select class="form-control" id="editRoleImportance">
                                                        <option value="main" ${data.role_importance === "main" ? "selected" : ""}>🌟 主角</option>
                                                        <option value="supporting" ${data.role_importance === "supporting" ? "selected" : ""}>⭐ 配角</option>
                                                        <option value="minor" ${data.role_importance === "minor" ? "selected" : ""}>✨ 次要角色</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-chat-text me-1"></i>角色简介 *
                                                    </label>
                                                    <textarea class="form-control" id="editContent" rows="4" required>${data.description || ""}</textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-heart me-1"></i>性格特点
                                                    </label>
                                                    <textarea class="form-control" id="editPersonality" rows="3">${data.personality || ""}</textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-sort-numeric-down me-1"></i>显示顺序
                                                    </label>
                                                    <input type="number" class="form-control" id="editDisplayOrder" value="${data.display_order || 1}" min="1">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-toggle-on me-1"></i>发布状态
                                                    </label>
                                                    <select class="form-control" id="editStatus">
                                                        <option value="published" ${data.status === "published" ? "selected" : ""}>✅ 已发布</option>
                                                        <option value="draft" ${data.status === "draft" ? "selected" : ""}>📝 草稿</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-lg me-1"></i>取消
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="updateItem(${id})">
                                        <i class="bi bi-check-lg me-1"></i>保存修改
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        } else if (currentPage === "story") {
          modal.innerHTML = `
                    <div class="modal fade" id="editModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">编辑剧情简介</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editForm">
                                        <div class="mb-3">
                                            <label class="form-label">标题</label>
                                            <input type="text" class="form-control" id="editTitle" value="${data.title || ""}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">内容</label>
                                            <textarea class="form-control" id="editContent" rows="5">${data.content || ""}</textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">章节编号</label>
                                            <input type="number" class="form-control" id="editChapterNumber" value="${data.chapter_number || 0}" min="0">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">显示顺序</label>
                                            <input type="number" class="form-control" id="editDisplayOrder" value="${data.display_order || 1}" min="1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">状态</label>
                                            <select class="form-control" id="editStatus">
                                                <option value="published" ${data.status === "published" ? "selected" : ""}>已发布</option>
                                                <option value="draft" ${data.status === "draft" ? "selected" : ""}>草稿</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="updateItem(${id})">保存</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        } else if (currentPage === "quotes") {
          modal.innerHTML = `
                    <div class="modal fade" id="editModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">编辑人物语录</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editForm">
                                        <div class="mb-3">
                                            <label class="form-label">人物名称</label>
                                            <input type="text" class="form-control" id="editTitle" value="${data.character_name || ""}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">语录内容</label>
                                            <textarea class="form-control" id="editContent" rows="5">${data.content || ""}</textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">图片地址</label>
                                            <input type="text" class="form-control" id="editImage" value="${data.image_url || ""}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">状态</label>
                                            <select class="form-control" id="editStatus">
                                                <option value="published" ${data.status === "published" ? "selected" : ""}>已发布</option>
                                                <option value="draft" ${data.status === "draft" ? "selected" : ""}>草稿</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="updateItem(${id})">保存</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        } else {
          modal.innerHTML = `
                    <div class="modal fade" id="editModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">编辑内容</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editForm">
                                        <div class="mb-3">
                                            <label class="form-label">标题/名称</label>
                                            <input type="text" class="form-control" id="editTitle" value="${data.title || data.name || data.username || ""}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">内容/描述</label>
                                            <textarea class="form-control" id="editContent" rows="3">${data.content || data.description || ""}</textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">状态</label>
                                            <select class="form-control" id="editStatus">
                                                <option value="published" ${data.status === "published" ? "selected" : ""}>已发布</option>
                                                <option value="draft" ${data.status === "draft" ? "selected" : ""}>草稿</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="updateItem(${id})">保存</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }

        document.body.appendChild(modal);
        const modalEl = document.getElementById("editModal");
        const bootstrapModal = new bootstrap.Modal(modalEl);
        bootstrapModal.show();
      }

      async function updateItem(id) {
        const title = document.getElementById("editTitle").value;
        const content = document.getElementById("editContent").value;
        const status = document.getElementById("editStatus").value;

        if (!title) {
          alert("请输入标题");
          return;
        }

        try {
          const apiBaseUrl = getApiBaseUrl();
          let apiUrl = "";
          let data = {};

          if (currentPage === "characters") {
            const image = document.getElementById("editImage").value;
            const personality = document.getElementById("editPersonality").value;
            const roleImportance = document.getElementById("editRoleImportance").value;
            const displayOrder = document.getElementById("editDisplayOrder").value;
            
            // 验证图片URL
            const imageInput = document.getElementById("editImage");
            if (image && imageInput.classList.contains('is-invalid')) {
              alert("请输入有效的图片地址");
              return;
            }

            apiUrl = `${apiBaseUrl}/admin/character/${id}`;
            data = {
              name: title,
              description: content,
              image_url: image,
              personality: personality,
              role_importance: roleImportance,
              display_order: parseInt(displayOrder) || 1,
              status,
            };
          } else if (currentPage === "story") {
            const chapterNumber = document.getElementById("editChapterNumber")?.value || 0;
            const displayOrder = document.getElementById("editDisplayOrder")?.value || 1;
            
            apiUrl = `${apiBaseUrl}/admin/story-intro/${id}`;
            data = {
              title,
              content,
              chapter_number: parseInt(chapterNumber) || 0,
              display_order: parseInt(displayOrder) || 1,
              status
            };
          } else if (currentPage === "reviews") {
            const rating = document.getElementById("editRating")?.value || 5;
            const reviewDate = document.getElementById("editReviewDate")?.value || new Date().toISOString().split('T')[0];
            
            apiUrl = `${apiBaseUrl}/admin/work-review/${id}`;
            data = {
              username: title,
              content: content,
              rating: parseInt(rating) || 5,
              review_date: reviewDate,
              status
            };
          } else if (currentPage === "quotes") {
            const image = document.getElementById("editImage").value;

            apiUrl = `${apiBaseUrl}/admin/quotes/${id}`;
            data = {
              character_name: title,
              content: content,
              image_url: image,
              status,
            };
          } else {
            apiUrl = `${apiBaseUrl}/admin/home-content/${id}`;
            data = { title, content, status };
          }

          const response = await fetch(apiUrl, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
            },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (result.success) {
            bootstrap.Modal.getInstance(
              document.getElementById("editModal"),
            ).hide();
            loadPageData(currentPage);
            alert("更新成功");
          } else {
            alert("更新失败: " + (result.error || "未知错误"));
          }
        } catch (error) {
          alert("更新失败: " + error.message);
        }
      }

      async function deleteItem(id, type) {
        if (!confirm("确定要删除这条记录吗？")) return;

        try {
          const apiBaseUrl = getApiBaseUrl();
          let apiUrl = "";
          if (type === "characters") {
            apiUrl = `${apiBaseUrl}/admin/character/${id}`;
          } else if (type === "story") {
            apiUrl = `${apiBaseUrl}/admin/story-intro/${id}`;
          } else if (type === "reviews") {
            apiUrl = `${apiBaseUrl}/admin/work-review/${id}`;
          } else if (type === "message") {
            apiUrl = `${apiBaseUrl}/admin/message/${id}`;
          } else if (type === "quotes") {
            apiUrl = `${apiBaseUrl}/admin/quotes/${id}`;
          } else if (type === "Basic_Information") {
            apiUrl = `${apiBaseUrl}/admin/basic-info/${id}`;
          } else {
            apiUrl = `${apiBaseUrl}/admin/home-content/${id}`;
          }

          const response = await fetch(apiUrl, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
            },
          });
          const result = await response.json();

          if (result.success) {
            loadPageData(currentPage);
            alert("删除成功");
          } else {
            alert("删除失败: " + (result.error || "未知错误"));
          }
        } catch (error) {
          alert("删除失败: " + error.message);
        }
      }

      function replyMessage(id) {
        const reply = prompt("请输入回复内容:");
        if (!reply || !reply.trim()) {
          return;
        }

        submitReply(id, reply.trim());
      }

      async function approveMessage(id) {
        if (!confirm("确定要发布这条留言吗？")) return;

        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(
            `${apiBaseUrl}/admin/message/${id}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
              },
              body: JSON.stringify({ status: "published" }),
            },
          );

          const result = await response.json();

          if (result.success) {
            loadPageData(currentPage);
            alert("留言已发布");
          } else {
            alert("发布失败: " + (result.error || "未知错误"));
          }
        } catch (error) {
          alert("发布失败: " + error.message);
        }
      }

      async function submitReply(id, replyContent) {
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(
            `${apiBaseUrl}/admin/message/${id}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
              },
              body: JSON.stringify({ reply: replyContent }),
            },
          );

          const result = await response.json();

          if (result.success) {
            loadPageData(currentPage);
            alert("回复成功");
          } else {
            alert("回复失败: " + (result.error || "未知错误"));
          }
        } catch (error) {
          alert("回复失败: " + error.message);
        }
      }

      async function approveReview(id) {
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(
            `${apiBaseUrl}/admin/work-review/${id}/status`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
              },
              body: JSON.stringify({ status: "approved" }),
            },
          );

          const result = await response.json();

          if (result.success) {
            loadPageData(currentPage);
            alert("评价审核通过，已在首页显示");
          } else {
            alert("审核失败: " + (result.error || "未知错误"));
          }
        } catch (error) {
          alert("审核失败: " + error.message);
        }
      }

      async function rejectReview(id) {
        if (!confirm("确定要拒绝这条评价吗？")) return;

        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(
            `${apiBaseUrl}/admin/work-review/${id}/status`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
              },
              body: JSON.stringify({ status: "rejected" }),
            },
          );

          const result = await response.json();

          if (result.success) {
            loadPageData(currentPage);
            alert("评价已拒绝");
          } else {
            alert("拒绝失败: " + (result.error || "未知错误"));
          }
        } catch (error) {
          alert("拒绝失败: " + error.message);
        }
      }

      async function viewReview(id) {
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(
            `${apiBaseUrl}/admin/work-review/${id}`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
              },
            },
          );

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              showReviewModal(result.data);
            } else {
              alert("获取评价详情失败: " + (result.error || "未知错误"));
            }
          } else {
            alert("获取评价详情失败");
          }
        } catch (error) {
          alert("获取评价详情失败: " + error.message);
        }
      }

      function showReviewModal(review) {
        // 清理已存在的模态框
        const existingModal = document.getElementById("reviewModal");
        if (existingModal) {
          existingModal.remove();
        }

        const stars = "★".repeat(review.rating) + "☆".repeat(5 - review.rating);
        const statusText =
          review.status === "approved"
            ? "已审核"
            : review.status === "rejected"
              ? "已拒绝"
              : "待审核";

        const modal = document.createElement("div");
        modal.innerHTML = `
                <div class="modal fade" id="reviewModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">评价详情</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>用户名：</strong> ${review.username}</p>
                                        <p><strong>评分：</strong> ${stars} (${review.rating}/5)</p>
                                        <p><strong>状态：</strong> ${statusText}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>提交时间：</strong> ${formatDate(review.create_time)}</p>
                                        <p><strong>更新时间：</strong> ${formatDate(review.update_time)}</p>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <p><strong>评价内容：</strong></p>
                                    <div class="border p-3 bg-light rounded">${review.content}</div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                ${
                                  review.status === "pending"
                                    ? `
                                    <button type="button" class="btn btn-success" onclick="approveReview(${review.id}); bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();">通过审核</button>
                                    <button type="button" class="btn btn-warning" onclick="rejectReview(${review.id}); bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();">拒绝审核</button>
                                `
                                    : ""
                                }
                                <button type="button" class="btn btn-danger" onclick="deleteItem(${review.id}, 'reviews'); bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();">删除评价</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        document.body.appendChild(modal);
        const modalEl = document.getElementById("reviewModal");
        const bootstrapModal = new bootstrap.Modal(modalEl);
        bootstrapModal.show();
      }

      function logout() {
        if (confirm("确定要退出登录吗？")) {
          localStorage.removeItem("admin_token");
          localStorage.removeItem("admin_user");
          localStorage.removeItem("admin_role");
          window.location.href = "../user-web/登录页面.html";
        }
      }

      // initPage函数已在文件前面定义，此处不再重复定义
      // updateAdminWelcome函数已在文件前面定义，此处不再重复定义

      function applySiteSettings() {
        const siteInfo = getSiteInfo();
        // 更新页面标题
        document.title = `后台管理系统 - ${siteInfo.title}`;
        // 更新导航栏标题
        const navbarBrand = document.querySelector(".navbar-brand");
        if (navbarBrand) {
          navbarBrand.innerHTML = `<i class="bi bi-shield-check"></i> ${siteInfo.title}管理系统`;
        }
      }

      function toggleSelectAll() {
        const selectAll = document.getElementById("selectAll");
        const checkboxes = document.querySelectorAll(".item-checkbox");
        checkboxes.forEach((cb) => (cb.checked = selectAll.checked));
        updateDeleteButton();
      }

      function updateDeleteButton() {
        const checkboxes = document.querySelectorAll(".item-checkbox:checked");
        const deleteBtn = document.getElementById("deleteSelectedBtn");

        if (checkboxes.length > 0) {
          deleteBtn.style.display = "inline-block";
          deleteBtn.innerHTML = `<i class="bi bi-trash"></i> 删除选中 (${checkboxes.length})`;
        } else {
          deleteBtn.style.display = "none";
        }
      }

      function renderSiteInfoPage() {
        const cardBody = document.querySelector(".card-body");
        const cardHeader = document.querySelector(".card-header");

        // 更新卡片头部
        cardHeader.innerHTML = `
                <h5>网站基本信息</h5>
                <button class="btn btn-primary btn-sm" onclick="saveSiteInfo()">保存设置</button>
            `;

        // 获取当前设置
        const siteInfo = getSiteInfo();

        cardBody.innerHTML = `
                <form id="siteInfoForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">网站标题</label>
                                <input type="text" class="form-control" id="siteTitle" value="${siteInfo.title}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">网站副标题</label>
                                <input type="text" class="form-control" id="siteSubtitle" value="${siteInfo.subtitle}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">网站描述</label>
                                <textarea class="form-control" id="siteDescription" rows="3">${siteInfo.description}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">关键词</label>
                                <input type="text" class="form-control" id="siteKeywords" value="${siteInfo.keywords}" placeholder="用逗号分隔">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">联系邮箱</label>
                                <input type="email" class="form-control" id="contactEmail" value="${siteInfo.contactEmail}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">联系电话</label>
                                <input type="text" class="form-control" id="contactPhone" value="${siteInfo.contactPhone}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">网站地址</label>
                                <input type="url" class="form-control" id="siteUrl" value="${siteInfo.siteUrl}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">版权信息</label>
                                <input type="text" class="form-control" id="copyright" value="${siteInfo.copyright}">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">首页欢迎词</label>
                                <textarea class="form-control" id="welcomeMessage" rows="2">${siteInfo.welcomeMessage}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">网站公告</label>
                                <textarea class="form-control" id="announcement" rows="3">${siteInfo.announcement}</textarea>
                            </div>
                        </div>
                    </div>
                </form>
            `;
      }

      function getSiteInfo() {
        // 从 localStorage 获取设置，或者返回默认值
        const defaultInfo = {
          title: "天官赐福",
          subtitle: "一部仙侠奇缘小说",
          description:
            "讲述了谢怜和花城的仙侠爱情故事，充满了奇幻色彩和深情厚意。",
          keywords: "天官赐福,谢怜,花城,仙侠小说,耳雅",
          contactEmail: "admin@tianguancifu.com",
          contactPhone: "400-123-4567",
          siteUrl: "https://tianguancifu.com",
          copyright: "© 2024 天官赐福. 版权所有.",
          welcomeMessage:
            "欢迎来到天官赐福的世界，这里有最精彩的仙侠故事和最动人的爱情传说。",
          announcement: "网站正在持续更新中，敬请期待更多精彩内容！",
        };

        const saved = localStorage.getItem("siteInfo");
        return saved ? { ...defaultInfo, ...JSON.parse(saved) } : defaultInfo;
      }

      async function saveSiteInfo() {
        const siteInfo = {
          title: document.getElementById("siteTitle").value,
          subtitle: document.getElementById("siteSubtitle").value,
          description: document.getElementById("siteDescription").value,
          keywords: document.getElementById("siteKeywords").value,
          contactEmail: document.getElementById("contactEmail").value,
          contactPhone: document.getElementById("contactPhone").value,
          siteUrl: document.getElementById("siteUrl").value,
          copyright: document.getElementById("copyright").value,
          welcomeMessage: document.getElementById("welcomeMessage").value,
          announcement: document.getElementById("announcement").value,
        };

        try {
          // 尝试保存到后端
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(
            `${apiBaseUrl}/admin/site-settings`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
              },
              body: JSON.stringify(siteInfo),
            },
          );

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              // 后端保存成功
              localStorage.setItem("siteInfo", JSON.stringify(siteInfo));
              applySiteSettings();
              alert("网站设置保存成功！");
              return;
            }
          }
          throw new Error("后端保存失败");
        } catch (error) {
          console.warn("后端保存失败，使用本地存储:", error);
          // 后端保存失败，使用本地存储
          localStorage.setItem("siteInfo", JSON.stringify(siteInfo));
          applySiteSettings();
          alert("网站设置已保存到本地！");
        }
      }



      /**
       * 编辑基本信息
       */
      async function editBasicInfo(id) {
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(
            `${apiBaseUrl}/admin/basic-info/${id}`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
              },
            },
          );

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              showBasicInfoEditModal(result.data, id);
            } else {
              alert("获取基本信息失败: " + (result.error || "未知错误"));
            }
          } else {
            alert("获取基本信息失败");
          }
        } catch (error) {
          console.error("获取基本信息失败:", error);
          alert("获取基本信息失败: " + error.message);
        }
      }

      /**
       * 显示基本信息编辑模态框
       */
      function showBasicInfoEditModal(data, id) {
        const existingModal = document.getElementById("basicInfoEditModal");
        if (existingModal) {
          existingModal.remove();
        }

        const modal = document.createElement("div");
        modal.innerHTML = `
                <div class="modal fade" id="basicInfoEditModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">编辑基本信息</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="basicInfoEditForm">
                                    <div class="mb-3">
                                        <label class="form-label">标签名称</label>
                                        <input type="text" class="form-control" id="editBasicLabel" value="${data.label || ""}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">内容值</label>
                                        <textarea class="form-control" id="editBasicValue" rows="3" required>${data.value || ""}</textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">显示顺序</label>
                                        <input type="number" class="form-control" id="editBasicOrder" value="${data.display_order || 0}" min="0">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" onclick="updateBasicInfo(${id})">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        document.body.appendChild(modal);
        const modalEl = document.getElementById("basicInfoEditModal");
        const bootstrapModal = new bootstrap.Modal(modalEl);
        bootstrapModal.show();
      }

      /**
       * 更新基本信息
       */
      async function updateBasicInfo(id) {
        const label = document.getElementById("editBasicLabel").value;
        const value = document.getElementById("editBasicValue").value;
        const displayOrder = document.getElementById("editBasicOrder").value;

        if (!label || !value) {
          alert("请填写标签名称和内容值");
          return;
        }

        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(
            `${apiBaseUrl}/admin/basic-info/${id}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
              },
              body: JSON.stringify({
                label: label,
                value: value,
                display_order: parseInt(displayOrder) || 0,
              }),
            },
          );

          const result = await response.json();

          if (result.success) {
            bootstrap.Modal.getInstance(
              document.getElementById("basicInfoEditModal"),
            ).hide();
            loadPageData(currentPage);
            alert("基本信息更新成功");
          } else {
            alert("更新失败: " + (result.error || "未知错误"));
          }
        } catch (error) {
          console.error("更新基本信息失败:", error);
          alert("更新失败: " + error.message);
        }
      }

      async function deleteSelected() {
        const checkboxes = document.querySelectorAll(".item-checkbox:checked");
        if (checkboxes.length === 0) return;

        if (!confirm(`确定要删除选中的 ${checkboxes.length} 条记录吗？`))
          return;

        const ids = Array.from(checkboxes).map((cb) => cb.value);

        let successCount = 0;
        let failedCount = 0;

        for (const id of ids) {
          try {
            const apiBaseUrl = getApiBaseUrl();
            let apiUrl = "";
            if (currentPage === "characters") {
              apiUrl = `${apiBaseUrl}/admin/character/${id}`;
            } else if (currentPage === "story") {
              apiUrl = `${apiBaseUrl}/admin/story-intro/${id}`;
            } else if (currentPage === "reviews") {
              apiUrl = `${apiBaseUrl}/admin/work-review/${id}`;
            } else if (currentPage === "messages") {
              apiUrl = `${apiBaseUrl}/admin/message/${id}`;
            } else if (currentPage === "quotes") {
              apiUrl = `${apiBaseUrl}/admin/quotes/${id}`;
            } else if (currentPage === "Basic_Information") {
              apiUrl = `${apiBaseUrl}/admin/basic-info/${id}`;
            } else if (currentPage === "carousel") {
              apiUrl = `${apiBaseUrl}/admin/carousel/${id}`;
            } else {
              apiUrl = `${apiBaseUrl}/admin/home-content/${id}`;
            }

            const response = await fetch(apiUrl, {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("admin_token") || ""}`,
              },
            });

            if (response.ok) {
              successCount++;
            } else {
              failedCount++;
            }
          } catch (error) {
            failedCount++;
          }
        }

        // 重新加载数据
        loadPageData(currentPage);

        // 重置选择状态
        document.getElementById("selectAll").checked = false;
        updateDeleteButton();

        // 显示结果
        if (failedCount === 0) {
          alert(`成功删除 ${successCount} 条记录`);
        } else {
          alert(`删除完成：成功 ${successCount} 条，失败 ${failedCount} 条`);
        }
      }
      
      // 轮播图管理函数
      async function addCarouselItem() {
        const title = document.getElementById('addTitle').value;
        const imageUrl = document.getElementById('addImageUrl').value;
        const linkUrl = document.getElementById('addLinkUrl').value;
        const description = document.getElementById('addDescription').value;
        const displayOrder = document.getElementById('addOrder').value;
        const isActive = document.getElementById('addActive').checked;
        
        if (!title || !imageUrl) {
          alert('请填写标题和图片URL');
          return;
        }
        
        // 验证图片URL
        const imageInput = document.getElementById('addImageUrl');
        if (imageInput.classList.contains('is-invalid')) {
          alert('请输入有效的图片地址');
          return;
        }
        
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(`${apiBaseUrl}/admin/carousel`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('admin_token') || ''}`
            },
            body: JSON.stringify({
              title: title,
              image_url: imageUrl,
              link_url: linkUrl || null,
              description: description || null,
              display_order: parseInt(displayOrder) || 0,
              is_active: isActive
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
            loadPageData(currentPage);
            alert('添加成功');
          } else {
            alert('添加失败: ' + result.error);
          }
        } catch (error) {
          console.error('添加轮播图失败:', error);
          alert('添加失败: ' + error.message);
        }
      }
      
      async function editCarousel(id) {
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(`${apiBaseUrl}/admin/carousel/${id}`, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('admin_token') || ''}`
            }
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              showCarouselEditModal(result.data, id);
            } else {
              alert('获取轮播图信息失败: ' + result.error);
            }
          } else {
            alert('获取轮播图信息失败');
          }
        } catch (error) {
          console.error('获取轮播图信息失败:', error);
          alert('获取轮播图信息失败: ' + error.message);
        }
      }
      
      function showCarouselEditModal(data, id) {
        const existingModal = document.getElementById('editCarouselModal');
        if (existingModal) {
          existingModal.remove();
        }
        
        const modal = document.createElement('div');
        modal.innerHTML = `
          <div class="modal fade" id="editCarouselModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                  <h5 class="modal-title">
                    <i class="bi bi-pencil-square me-2"></i>编辑轮播图
                  </h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <form id="editCarouselForm">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">
                            <i class="bi bi-card-text me-1"></i>轮播图标题 *
                          </label>
                          <input type="text" class="form-control" id="editCarouselTitle" value="${data.title || ''}" required>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">
                            <i class="bi bi-image me-1"></i>图片地址 *
                          </label>
                          <div class="input-group">
                            <input type="text" class="form-control" id="editCarouselImageUrl" value="${data.image_url || ''}" required onblur="validateImageUrl(this)">
                            <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('editImageFile').click()">
                              <i class="bi bi-upload"></i> 上传
                            </button>
                          </div>
                          <input type="file" id="editImageFile" accept="image/*" style="display: none;" onchange="handleImageUpload(this, 'editCarouselImageUrl')">
                          <div id="editImagePreview" class="mt-2">
                            <img id="editPreviewImg" src="${data.image_url || ''}" alt="预览" style="max-width: 200px; max-height: 100px; border-radius: 4px;" onerror="this.style.display='none'">
                          </div>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">
                            <i class="bi bi-link-45deg me-1"></i>点击链接
                          </label>
                          <input type="url" class="form-control" id="editCarouselLinkUrl" value="${data.link_url || ''}">
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">
                            <i class="bi bi-chat-text me-1"></i>轮播图描述
                          </label>
                          <textarea class="form-control" id="editCarouselDescription" rows="4">${data.description || ''}</textarea>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">
                            <i class="bi bi-sort-numeric-down me-1"></i>显示顺序
                          </label>
                          <input type="number" class="form-control" id="editCarouselOrder" value="${data.display_order || 0}" min="1">
                        </div>
                        <div class="mb-3">
                          <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editCarouselActive" ${data.is_active ? 'checked' : ''}>
                            <label class="form-check-label" for="editCarouselActive">
                              <i class="bi bi-toggle-on me-1"></i>启用轮播图
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-12">
                        <div class="alert alert-warning">
                          <i class="bi bi-exclamation-triangle me-2"></i>
                          <strong>注意：</strong>修改后的轮播图将立即在前台生效，请确保信息准确。
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i>取消
                  </button>
                  <button type="button" class="btn btn-primary" onclick="updateCarousel(${id})">
                    <i class="bi bi-check-lg me-1"></i>保存修改
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        const modalEl = document.getElementById('editCarouselModal');
        const bootstrapModal = new bootstrap.Modal(modalEl);
        bootstrapModal.show();
      }
      
      async function updateCarousel(id) {
        const title = document.getElementById('editCarouselTitle').value;
        const imageUrl = document.getElementById('editCarouselImageUrl').value;
        const linkUrl = document.getElementById('editCarouselLinkUrl').value;
        const description = document.getElementById('editCarouselDescription').value;
        const displayOrder = document.getElementById('editCarouselOrder').value;
        const isActive = document.getElementById('editCarouselActive').checked;
        
        if (!title || !imageUrl) {
          alert('请填写标题和图片URL');
          return;
        }
        
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(`${apiBaseUrl}/admin/carousel/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('admin_token') || ''}`
            },
            body: JSON.stringify({
              title: title,
              image_url: imageUrl,
              link_url: linkUrl || null,
              description: description || null,
              display_order: parseInt(displayOrder) || 0,
              is_active: isActive
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('editCarouselModal')).hide();
            loadPageData(currentPage);
            alert('更新成功');
          } else {
            alert('更新失败: ' + result.error);
          }
        } catch (error) {
          console.error('更新轮播图失败:', error);
          alert('更新失败: ' + error.message);
        }
      }
      
      async function deleteCarousel(id) {
        if (!confirm('确定要删除这个轮播图吗？')) {
          return;
        }
        
        try {
          const apiBaseUrl = getApiBaseUrl();
          const response = await fetch(`${apiBaseUrl}/admin/carousel/${id}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('admin_token') || ''}`
            }
          });
          
          const result = await response.json();
          
          if (result.success) {
            loadPageData(currentPage);
            alert('删除成功');
          } else {
            alert('删除失败: ' + result.error);
          }
        } catch (error) {
          console.error('删除轮播图失败:', error);
          alert('删除失败: ' + error.message);
        }
      }
      
      // 图片上传和验证函数
      function showUploadProgress() {
        const overlay = document.createElement('div');
        overlay.className = 'upload-overlay';
        overlay.id = 'uploadOverlay';
        
        const progress = document.createElement('div');
        progress.className = 'upload-progress';
        progress.id = 'uploadProgress';
        progress.innerHTML = `
          <div style="margin-bottom: 15px;">
            <i class="bi bi-cloud-upload" style="font-size: 2rem; color: #9e2a2b;"></i>
          </div>
          <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 10px;">正在上传图片...</div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          <div id="progressText">0%</div>
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(progress);
      }
      
      function hideUploadProgress() {
        const overlay = document.getElementById('uploadOverlay');
        const progress = document.getElementById('uploadProgress');
        if (overlay) overlay.remove();
        if (progress) progress.remove();
      }
      
      function updateProgress(percent) {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        if (progressBar) progressBar.style.width = percent + '%';
        if (progressText) progressText.textContent = Math.round(percent) + '%';
      }

      async function handleImageUpload(fileInput, targetInputId) {
        const file = fileInput.files[0];
        if (!file) return;
        
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
          alert('只支持JPG、PNG、GIF、WebP格式的图片');
          return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
          alert('图片过大，请上传小于5MB');
          fileInput.value = '';
          return;
        }
        
        showUploadProgress();
        
        const targetInput = document.getElementById(targetInputId);
        const originalPlaceholder = targetInput.placeholder;
        targetInput.placeholder = '正在上传...';
        targetInput.disabled = true;
        
        const formData = new FormData();
        formData.append('file', file);
        
        // 模拟进度
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress > 90) progress = 90;
          updateProgress(progress);
        }, 100);
        
        try {
          const response = await fetch('/api/admin/upload-image', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('admin_token') || ''}`
            },
            body: formData
          });
          
          clearInterval(progressInterval);
          updateProgress(100);
          
          const result = await response.json();
          
          setTimeout(() => {
            if (result.success) {
              targetInput.value = result.data.url;
              targetInput.classList.remove('is-invalid');
              targetInput.classList.add('is-valid');
              updateImagePreview(targetInputId, result.data.url);
              alert('图片上传成功！');
            } else {
              alert('上传失败: ' + result.error);
            }
            hideUploadProgress();
          }, 500);
        } catch (error) {
          clearInterval(progressInterval);
          console.error('上传图片失败:', error);
          
          const reader = new FileReader();
          reader.onload = function(e) {
            const localUrl = e.target.result;
            targetInput.value = localUrl;
            updateImagePreview(targetInputId, localUrl);
            alert('后端上传失败，已使用本地预览。请手动输入图片地址。');
            hideUploadProgress();
          };
          reader.readAsDataURL(file);
        } finally {
          targetInput.placeholder = originalPlaceholder;
          targetInput.disabled = false;
        }
      }
      
      function validateImageUrl(input) {
        const url = input.value.trim();
        if (!url) {
          input.classList.remove('is-invalid', 'is-valid');
          hideImagePreview(input.id);
          return;
        }
        
        // 验证URL格式（支持相对路径、绝对URL和base64）
        const urlPattern = /^(https?:\/\/|\.\.?\/|data:image\/)/;
        if (!urlPattern.test(url)) {
          input.classList.add('is-invalid');
          input.classList.remove('is-valid');
          hideImagePreview(input.id);
          return;
        }
        
        // 如果是base64格式，直接通过
        if (url.startsWith('data:image/')) {
          input.classList.remove('is-invalid');
          input.classList.add('is-valid');
          updateImagePreview(input.id, url);
          return;
        }
        
        // 验证图片扩展名
        const imagePattern = /\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i;
        if (!imagePattern.test(url)) {
          input.classList.add('is-invalid');
          input.classList.remove('is-valid');
          hideImagePreview(input.id);
          return;
        }
        
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
        updateImagePreview(input.id, url);
      }
      
      function hideImagePreview(inputId) {
        const previewId = inputId.replace('add', 'add') + 'Preview';
        const previewDiv = document.getElementById(previewId) || 
                          document.getElementById(inputId.replace('Image', 'ImagePreview')) ||
                          document.getElementById(inputId.replace('ImageUrl', 'ImagePreview'));
        if (previewDiv) {
          previewDiv.style.display = 'none';
        }
      }
      
      function updateImagePreview(inputId, url) {
        // 智能匹配预览元素ID
        let previewDiv, previewImg;
        
        // 尝试多种命名规则
        const possiblePreviewIds = [
          inputId + 'Preview',
          inputId.replace('Image', 'ImagePreview'),
          inputId.replace('ImageUrl', 'ImagePreview'),
          inputId.replace('add', 'add') + 'Preview'
        ];
        
        const possibleImgIds = [
          inputId + 'PreviewImg',
          inputId.replace('Image', 'PreviewImg'),
          inputId.replace('ImageUrl', 'PreviewImg'),
          inputId.replace('add', 'add') + 'PreviewImg'
        ];
        
        // 查找预览元素
        for (const id of possiblePreviewIds) {
          const element = document.getElementById(id);
          if (element) {
            previewDiv = element;
            break;
          }
        }
        
        for (const id of possibleImgIds) {
          const element = document.getElementById(id);
          if (element) {
            previewImg = element;
            break;
          }
        }
        
        if (previewDiv && previewImg) {
          // 修复图片URL，确保本地环境使用正确路径
          const fixedUrl = fixImageUrl(url);
          previewImg.src = fixedUrl;
          previewImg.onload = () => {
            previewDiv.style.display = 'block';
          };
          previewImg.onerror = () => {
            previewDiv.style.display = 'none';
            // 如果图片加载失败，标记输入框为无效
            const input = document.getElementById(inputId);
            if (input && !url.startsWith('data:')) {
              input.classList.add('is-invalid');
              input.classList.remove('is-valid');
            }
          };
        }
      }
      
      // 添加输入验证事件监听
      document.addEventListener('DOMContentLoaded', function() {
        // 为所有图片输入框添加实时验证
        document.addEventListener('input', function(e) {
          if (e.target.id && (e.target.id.includes('Image') || e.target.id.includes('ImageUrl'))) {
            validateImageUrl(e.target);
          }
        });
        
        // 为所有表单添加提交验证
        document.addEventListener('submit', function(e) {
          const form = e.target;
          const requiredInputs = form.querySelectorAll('input[required], textarea[required]');
          let isValid = true;
          
          requiredInputs.forEach(input => {
            if (!input.value.trim()) {
              input.classList.add('is-invalid');
              isValid = false;
            } else {
              input.classList.remove('is-invalid');
            }
          });
          
          if (!isValid) {
            e.preventDefault();
            alert('请填写所有必填项');
          }
        });
      });
    </script>
  </body>
</html>
