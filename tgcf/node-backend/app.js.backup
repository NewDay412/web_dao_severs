const express = require('express');
const cors = require('cors');
const path = require('path');
const morgan = require('morgan');
const helmet = require('helmet');
const jwt = require('jsonwebtoken');

// å¯¼å…¥è·¯ç”±
const userRoutes = require('./api/user.routes');
const adminRoutes = require('./api/admin.routes');
const chatRoutes = require('./api/chat.routes');
const userChatRoutes = require('./api/userChat.routes');
const adminChatRoutes = require('./api/adminChat.routes');

// å¯¼å…¥æ•°æ®åº“é…ç½®
const db = require('./config/db');

// å¯¼å…¥æ¨¡å‹
const { UserModel, AdminModel } = require('./models/user.model');

// JWTå¯†é’¥
const JWT_SECRET = process.env.JWT_SECRET || 'your_secret_key';

// åˆ›å»ºExpressåº”ç”¨å®ä¾‹
const app = express();
const PORT = process.env.PORT || 3003;

/**
 * å®‰å…¨ä¸­é—´ä»¶é…ç½®
 */
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'", "'unsafe-eval'"],
      scriptSrcAttr: ["'unsafe-inline'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "*.baidu.com"],
      fontSrc: ["'self'", "data:", "fonts.gstatic.com"],
      connectSrc: ["'self'", "rumt-zh.com"],
    },
  },
})); // å®‰å…¨å¤´éƒ¨è®¾ç½®

/**
 * è·¨åŸŸé…ç½®
 * æ”¯æŒå‰ç«¯å¼€å‘å¸¸ç”¨ç«¯å£
 */
const corsOptions = {
  origin: function (origin, callback) {
    // å…è®¸æ²¡æœ‰originçš„è¯·æ±‚ï¼ˆå¦‚file://åè®®ï¼‰
    if (!origin) return callback(null, true);
    
    const allowedOrigins = [
      'http://localhost',
      'http://localhost:80',
      'http://localhost:3003',
      'http://localhost:5173',
      'http://localhost:8080',
      'http://localhost:8000',
      'http://dao.longlong.baby',
      'https://dao.longlong.baby',
      'http://longlong.baby',
      'https://longlong.baby',
      'http://47.83.203.60',
      'http://47.83.203.60:3003'
    ];
    
    if (allowedOrigins.indexOf(origin) !== -1 || origin.startsWith('file://')) {
      callback(null, true);
    } else {
      callback(null, true); // å¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰æ¥æº
    }
  },
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],
  credentials: true,
  maxAge: 3600
};
app.use(cors(corsOptions));

/**
 * è¯·æ±‚æ—¥å¿—
 * ä½¿ç”¨morganè®°å½•HTTPè¯·æ±‚
 */
app.use(morgan('combined'));

/**
 * æ•°æ®è§£æä¸­é—´ä»¶
 */
app.use(express.json({ limit: '10mb' })); // JSONè§£æï¼Œè®¾ç½®å¤§å°é™åˆ¶
app.use(express.urlencoded({ extended: true, limit: '10mb' })); // URLç¼–ç è§£æ

/**
 * é™æ€æ–‡ä»¶æœåŠ¡
 */
app.use(express.static(path.join(__dirname, '..')));
app.use('/user-web', express.static(path.join(__dirname, '../user-web')));
app.use('/admin-web', express.static(path.join(__dirname, '../admin-web')));
app.use('/img', express.static(path.join(__dirname, '../img')));
app.use('/css', express.static(path.join(__dirname, '../css')));
app.use('/js', express.static(path.join(__dirname, '../js')));
app.use('/bootstrap-5.3.2', express.static(path.join(__dirname, '../bootstrap-5.3.2')));
app.use('/icons-1.11.1', express.static(path.join(__dirname, '../icons-1.11.1')));
// å›¾ç‰‡ä¸Šä¼ ç›®å½• - æ”¯æŒç®¡ç†åå°ä¸Šä¼ çš„å›¾ç‰‡è®¿é—®
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));
app.use('/node-backend/uploads', express.static(path.join(__dirname, 'uploads')));

/**
 * å¥åº·æ£€æŸ¥æ¥å£
 */
app.get('/health', (req, res) => {
  res.status(200).json({
    status: 'ok',
    message: 'åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸',
    timestamp: new Date().toISOString().slice(0, 19).replace('T', ' '),
    version: '1.0.0'
  });
});

/**
 * æ ¹è·¯å¾„
 */
app.get('/', (req, res) => {
  res.redirect('/user-web/å¤©å®˜èµç¦é¦–é¡µ.html');
});

/**
 * ç»Ÿä¸€ç™»å½•æ¥å£
 * æ”¯æŒç®¡ç†å‘˜å’Œæ™®é€šç”¨æˆ·ç™»å½•ï¼Œæä¾›å®Œå–„çš„é”™è¯¯å¤„ç†
 */
app.post('/api/login', async (req, res) => {
  try {
    const { username, password } = req.body;
    const errorId = Date.now();

    // å‚æ•°éªŒè¯
    if (!username || !password) {
      return res.status(400).json({
        success: false,
        message: 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º',
        errorId
      });
    }

    // å…ˆå°è¯•ç®¡ç†å‘˜ç™»å½• - æ·»åŠ ç‹¬ç«‹é”™è¯¯å¤„ç†
    let user = null;
    try {
      user = await AdminModel.login(username, password);
      if (user) {
        const token = jwt.sign(
          { username: user.username, role: user.role },
          JWT_SECRET,
          { expiresIn: '2h' }
        );

        return res.json({
          success: true,
          token,
          user: { username: user.username, role: user.role },
          message: 'ç®¡ç†å‘˜ç™»å½•æˆåŠŸ'
        });
      }
    } catch (adminError) {
      console.error(`ç®¡ç†å‘˜ç™»å½•å¤±è´¥ [${errorId}]:`, adminError);
      // ç»§ç»­å°è¯•æ™®é€šç”¨æˆ·ç™»å½•
    }

    // å†å°è¯•æ™®é€šç”¨æˆ·ç™»å½• - æ·»åŠ ç‹¬ç«‹é”™è¯¯å¤„ç†
    try {
      user = await UserModel.login(username, password);
      if (user) {
        const token = jwt.sign(
          { username: user.username, role: 'user' },
          JWT_SECRET,
          { expiresIn: '2h' }
        );

        return res.json({
          success: true,
          token,
          user: { username: user.username, role: 'user' },
          message: 'ç”¨æˆ·ç™»å½•æˆåŠŸ'
        });
      }
    } catch (userError) {
      console.error(`æ™®é€šç”¨æˆ·ç™»å½•å¤±è´¥ [${errorId}]:`, userError);
      // ç»§ç»­å°è¯•é»˜è®¤è´¦å·
    }

    // é»˜è®¤ç®¡ç†å‘˜è´¦å·ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
    if (username === 'admin' && password === 'admin123') {
      const token = jwt.sign(
        { username: 'admin', role: 'admin' },
        JWT_SECRET,
        { expiresIn: '2h' }
      );

      return res.json({
        success: true,
        token,
        user: { username: 'admin', role: 'admin' },
        message: 'ç®¡ç†å‘˜ç™»å½•æˆåŠŸ'
      });
    }

    // é»˜è®¤ç”¨æˆ·è´¦å·ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
    if (username === 'user1' && password === 'password123') {
      const token = jwt.sign(
        { username: 'user1', role: 'user' },
        JWT_SECRET,
        { expiresIn: '2h' }
      );

      return res.json({
        success: true,
        token,
        user: { username: 'user1', role: 'user' },
        message: 'ç”¨æˆ·ç™»å½•æˆåŠŸ'
      });
    }

    // æ‰€æœ‰ç™»å½•æ–¹å¼éƒ½å¤±è´¥
    return res.status(401).json({
      success: false,
      message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯',
      errorId
    });

  } catch (error) {
    const errorId = Date.now();
    console.error(`ç™»å½•ç³»ç»Ÿå¼‚å¸¸ [${errorId}]:`, error);
    return res.status(500).json({
      success: false,
      message: 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
      errorId
    });
  }
});

/**
 * è·¯ç”±é…ç½®
 */
app.use('/api/user', userRoutes); // ç”¨æˆ·æ¥å£
app.use('/api/admin', adminRoutes); // ç®¡ç†å‘˜æ¥å£
app.use('/api/chat', chatRoutes); // èŠå¤©æ¥å£ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
app.use('/api/user-chat', userChatRoutes); // ç”¨æˆ·èŠå¤©æ¥å£
app.use('/api/admin-chat', adminChatRoutes); // ç®¡ç†å‘˜èŠå¤©æ¥å£



/**
 * 404å¤„ç†ä¸­é—´ä»¶
 */
app.use((req, res, next) => {
  res.status(404).json({
    success: false,
    error: 'æ¥å£ä¸å­˜åœ¨',
    path: req.path,
    method: req.method
  });
});

/**
 * å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
 */
app.use((err, req, res, next) => {
  // è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
  console.error('æœåŠ¡å™¨é”™è¯¯:', {
    message: err.message,
    stack: err.stack,
    path: req.path,
    method: req.method,
    timestamp: new Date().toISOString()
  });
  
  // é˜²æ­¢å¤´éƒ¨å·²å‘é€é”™è¯¯
  if (res.headersSent) {
    return next(err);
  }
  
  // è¿”å›å‹å¥½çš„é”™è¯¯å“åº”
  res.status(500).json({
    success: false,
    error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
    errorId: new Date().getTime()
  });
});

/**
 * å¯åŠ¨æœåŠ¡å™¨å‡½æ•°
 * @returns {Promise<void>}
 */
async function startServer() {
  try {
    // åˆå§‹åŒ–æ•°æ®åº“
    await db.initializeDatabase();
    console.log('âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ');

    // å¯åŠ¨HTTPæœåŠ¡å™¨ - ç»‘å®šåˆ°æ‰€æœ‰IPåœ°å€ä»¥æ”¯æŒå¤–éƒ¨è®¿é—®
    const server = app.listen(PORT, '0.0.0.0', () => {
      console.log(`ğŸš€ åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£: ${PORT}`);
      console.log(`ğŸ” æœ¬åœ°è®¿é—®: http://localhost:${PORT}`);
      console.log(`ğŸŒ IPè®¿é—®: http://47.83.203.60:${PORT}`);
      console.log(`ğŸŒ åŸŸåè®¿é—®: http://dao.longlong.baby:${PORT}`);
      console.log(`ğŸŒ åŸŸåè®¿é—®: http://longlong.baby:${PORT}`);
      console.log(`ğŸ‘¤ APIæ¥å£: /api/user | /api/admin`);
    });

    // è®¾ç½®æœåŠ¡å™¨è¶…æ—¶
    server.timeout = 120000; // 2åˆ†é’Ÿè¶…æ—¶
    server.keepAliveTimeout = 65000; // Keep-aliveè¶…æ—¶
    server.headersTimeout = 66000; // å¤´éƒ¨è¶…æ—¶

    // è¿”å›æœåŠ¡å™¨å®ä¾‹ï¼Œä¾¿äºæµ‹è¯•å’Œå…³é—­æ“ä½œ
    return server;
  } catch (error) {
    console.error('âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error);
    process.exit(1);
  }
}

/**
 * ä¼˜é›…å…³é—­å¤„ç†
 * ç¡®ä¿åœ¨é€€å‡ºæ—¶å…³é—­æ•°æ®åº“è¿æ¥
 */
function setupGracefulShutdown() {
  process.on('SIGINT', async () => {
    console.log('æ­£åœ¨å…³é—­æœåŠ¡å™¨...');
    try {
      if (db.pool) {
        await db.pool.end();
        console.log('âœ… æ•°æ®åº“è¿æ¥å·²å…³é—­');
      }
      process.exit(0);
    } catch (err) {
      console.error('âŒ å…³é—­æ•°æ®åº“è¿æ¥å¤±è´¥:', err);
      process.exit(1);
    }
  });
}

// å¯åŠ¨åº”ç”¨
if (require.main === module) {
  setupGracefulShutdown();
  startServer();
}

// å¯¼å‡ºæ¨¡å—ï¼Œä¾¿äºæµ‹è¯•
module.exports = {
  app,
  startServer
};