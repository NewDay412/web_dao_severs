# äº‘æœåŠ¡å™¨éƒ¨ç½²ä¿®å¤æŒ‡å—

## é—®é¢˜è¯Šæ–­ä¸è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒé—®é¢˜é“¾
1. **æ¥å£åœ°å€æ··ä¹±** - å‰ç«¯ä½¿ç”¨å¤šä¸ªä¸åŒçš„åŸºå‡†åœ°å€
2. **è·¨åŸŸé…ç½®ç¼ºå¤±** - æµè§ˆå™¨æ‹¦æˆªè¯·æ±‚è¿”å›HTMLé”™è¯¯é¡µ
3. **æ³¨å†Œæ¥å£è·¯å¾„é”™è¯¯** - å‰ç«¯è°ƒç”¨åœ°å€ä¸åç«¯å®ç°ä¸åŒ¹é…
4. **é”™è¯¯å¤„ç†é€»è¾‘ç¼ºé™·** - å°†404è¯¯åˆ¤ä¸º"ç”¨æˆ·ä¸å­˜åœ¨"

### å·²ä¿®å¤å†…å®¹
âœ… ç»Ÿä¸€å‰ç«¯æ¥å£åŸºå‡†åœ°å€ä¸ºç›¸å¯¹è·¯å¾„ `/api`
âœ… ä¿®å¤ç™»å½•å“åº”å­—æ®µåˆ¤æ–­ (`status` â†’ `success`)
âœ… ç»Ÿä¸€æ³¨å†Œæ¥å£åœ°å€ (`/api/user/register`)
âœ… ä¼˜åŒ–åç«¯è·¨åŸŸé…ç½®æ”¯æŒå¤šä¸ªåŸŸå

---

## äº‘æœåŠ¡å™¨éƒ¨ç½²æ­¥éª¤

### 1. SSHè¿æ¥åˆ°æœåŠ¡å™¨
```bash
ssh root@47.83.203.60
# å¯†ç : root
```

### 2. è¿›å…¥é¡¹ç›®ç›®å½•
```bash
cd /path/to/web_dao
# æˆ–æ ¹æ®å®é™…éƒ¨ç½²è·¯å¾„è°ƒæ•´
```

### 3. å¯åŠ¨åç«¯æœåŠ¡
```bash
cd node-backend
npm install  # å¦‚æœä¾èµ–æœªå®‰è£…
npm start
```

**é¢„æœŸè¾“å‡ºï¼š**
```
ğŸš€ åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£: 3003
ğŸ” æœ¬åœ°è®¿é—®: http://localhost:3003
ğŸŒ IPè®¿é—®: http://47.83.203.60:3003
ğŸŒ åŸŸåè®¿é—®: http://dao.longlong.baby:3003
ğŸ‘¤ APIæ¥å£: /api/user | /api/admin
```

### 4. éªŒè¯æœåŠ¡çŠ¶æ€
```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æµ‹è¯•
curl http://localhost:3003/health
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "status": "ok",
  "message": "åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸",
  "timestamp": "2024-01-15 10:30:45",
  "version": "1.0.0"
}
```

---

## æ¥å£åœ°å€ç»Ÿä¸€è§„èŒƒ

### å‰ç«¯è°ƒç”¨è§„èŒƒ
æ‰€æœ‰å‰ç«¯è¯·æ±‚ä½¿ç”¨**ç›¸å¯¹è·¯å¾„**ï¼Œç”±æµè§ˆå™¨è‡ªåŠ¨å¤„ç†åŸŸåï¼š

```javascript
// âœ… æ­£ç¡®ç”¨æ³•
fetch('/api/login', { method: 'POST', ... })
fetch('/api/user/register', { method: 'POST', ... })
fetch('/api/user/message', { method: 'GET', ... })

// âŒ é”™è¯¯ç”¨æ³•ï¼ˆå·²ä¿®å¤ï¼‰
fetch('http://localhost:3003/api/login', ...)  // æœ¬åœ°å¼€å‘ä¸“ç”¨
fetch('https://longlong.baby/api/login', ...)  // ç¡¬ç¼–ç åŸŸå
```

### åç«¯æ¥å£æ˜ å°„
| åŠŸèƒ½ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| ç™»å½• | POST | `/api/login` | ç»Ÿä¸€ç™»å½•æ¥å£ï¼ˆç®¡ç†å‘˜+ç”¨æˆ·ï¼‰ |
| æ³¨å†Œ | POST | `/api/user/register` | ç”¨æˆ·æ³¨å†Œ |
| è·å–ç•™è¨€ | GET | `/api/user/message` | è·å–ç•™è¨€åˆ—è¡¨ |
| æäº¤ç•™è¨€ | POST | `/api/user/message` | æäº¤æ–°ç•™è¨€ |
| è·å–è§’è‰² | GET | `/api/user/character` | è·å–è§’è‰²åˆ—è¡¨ |
| è·å–è¯„ä»· | GET | `/api/user/review` | è·å–ä½œå“è¯„ä»· |
| æäº¤è¯„ä»· | POST | `/api/user/review` | æäº¤ä½œå“è¯„ä»· |

---

## è·¨åŸŸé…ç½®è¯¦è§£

### åç«¯CORSé…ç½®ï¼ˆå·²ä¼˜åŒ–ï¼‰
```javascript
// node-backend/app.js ä¸­çš„è·¨åŸŸé…ç½®
const corsOptions = {
  origin: function (origin, callback) {
    const allowedOrigins = [
      'http://localhost',
      'http://localhost:3003',
      'http://dao.longlong.baby',
      'https://dao.longlong.baby',
      'http://47.83.203.60',
      'http://47.83.203.60:3003'
    ];
    
    if (allowedOrigins.indexOf(origin) !== -1 || !origin) {
      callback(null, true);
    } else {
      callback(null, true); // å¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰
    }
  },
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true
};
```

### æ”¯æŒçš„è®¿é—®æ–¹å¼
- âœ… `http://localhost:3003` - æœ¬åœ°å¼€å‘
- âœ… `http://47.83.203.60:3003` - IPç›´æ¥è®¿é—®
- âœ… `http://dao.longlong.baby` - åŸŸåè®¿é—®
- âœ… `https://dao.longlong.baby` - HTTPSè®¿é—®

---

## é”™è¯¯å¤„ç†è§„èŒƒ

### HTTPçŠ¶æ€ç å«ä¹‰
| çŠ¶æ€ç  | å«ä¹‰ | å‰ç«¯å¤„ç† |
|--------|------|---------|
| 200 | è¯·æ±‚æˆåŠŸ | æ£€æŸ¥ `result.success` å­—æ®µ |
| 400 | å‚æ•°éªŒè¯å¤±è´¥ | æ˜¾ç¤ºéªŒè¯é”™è¯¯ä¿¡æ¯ |
| 401 | è®¤è¯å¤±è´¥ï¼ˆå¯†ç é”™è¯¯ï¼‰ | æ˜¾ç¤º"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯" |
| 404 | æ¥å£ä¸å­˜åœ¨ | æ˜¾ç¤º"æ¥å£é…ç½®é”™è¯¯" |
| 500 | æœåŠ¡å™¨é”™è¯¯ | æ˜¾ç¤º"æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•" |

### å“åº”æ ¼å¼è§„èŒƒ
```javascript
// æˆåŠŸå“åº”
{
  "success": true,
  "message": "æ“ä½œæˆåŠŸ",
  "data": { ... }
}

// å¤±è´¥å“åº”
{
  "success": false,
  "message": "é”™è¯¯æè¿°",
  "errorId": 1234567890
}
```

### å‰ç«¯é”™è¯¯å¤„ç†ç¤ºä¾‹
```javascript
async function submitLogin(username, password) {
  try {
    const response = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });

    const result = await response.json();
    
    // æ£€æŸ¥ä¸šåŠ¡é€»è¾‘æˆåŠŸ/å¤±è´¥
    if (result.success) {
      // ç™»å½•æˆåŠŸ
      localStorage.setItem('token', result.token);
      window.location.href = '/user-web/å¤©å®˜èµç¦é¦–é¡µ.html';
    } else {
      // ä¸šåŠ¡é”™è¯¯ï¼ˆå¦‚ç”¨æˆ·ä¸å­˜åœ¨ã€å¯†ç é”™è¯¯ï¼‰
      showErrorModal('ç™»å½•å¤±è´¥', result.message);
    }
  } catch (error) {
    // ç½‘ç»œé”™è¯¯
    showErrorModal('ç½‘ç»œé”™è¯¯', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
  }
}
```

---

## æµ‹è¯•æ¸…å•

### 1. åç«¯æœåŠ¡æµ‹è¯•
```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://47.83.203.60:3003/health

# æµ‹è¯•ç™»å½•æ¥å£
curl -X POST http://47.83.203.60:3003/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# é¢„æœŸå“åº”
{
  "success": true,
  "token": "eyJhbGc...",
  "user": { "username": "admin", "role": "admin" },
  "message": "ç®¡ç†å‘˜ç™»å½•æˆåŠŸ"
}
```

### 2. å‰ç«¯åŠŸèƒ½æµ‹è¯•
- [ ] æ‰“å¼€ç™»å½•é¡µé¢ï¼š`http://47.83.203.60/user-web/ç™»å½•é¡µé¢.html`
- [ ] è¾“å…¥é»˜è®¤è´¦å·ï¼š`admin` / `admin123`
- [ ] éªŒè¯ç™»å½•æˆåŠŸå¹¶è·³è½¬åˆ°é¦–é¡µ
- [ ] æ‰“å¼€æ³¨å†Œé¡µé¢ï¼š`http://47.83.203.60/user-web/æ³¨å†Œ.html`
- [ ] å¡«å†™æ³¨å†Œä¿¡æ¯å¹¶æäº¤
- [ ] éªŒè¯æ³¨å†ŒæˆåŠŸå¹¶è·³è½¬åˆ°ç™»å½•é¡µ

### 3. è·¨åŸŸæµ‹è¯•
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
fetch('/api/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ username: 'admin', password: 'admin123' })
})
.then(r => r.json())
.then(d => console.log(d))
.catch(e => console.error(e))
```

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šSyntaxError: Unexpected token '<'
**åŸå› ï¼š** æ¥å£è¿”å›HTMLé”™è¯¯é¡µè€ŒéJSON
**è§£å†³ï¼š**
1. æ£€æŸ¥æ¥å£åœ°å€æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤åç«¯æœåŠ¡å·²å¯åŠ¨
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°Networkæ ‡ç­¾æŸ¥çœ‹å®é™…å“åº”

### é—®é¢˜2ï¼šç™»å½•æ˜¾ç¤º"ç”¨æˆ·ä¸å­˜åœ¨"
**åŸå› ï¼š** å‰ç«¯é”™è¯¯å¤„ç†é€»è¾‘æ··ä¹±
**è§£å†³ï¼š** å·²é€šè¿‡ä¿®å¤è„šæœ¬è§£å†³ï¼Œç¡®ä¿ï¼š
- 401çŠ¶æ€ç  = å¯†ç é”™è¯¯
- 404çŠ¶æ€ç  = æ¥å£ä¸å­˜åœ¨
- ä¸šåŠ¡é”™è¯¯é€šè¿‡ `result.message` ä¼ é€’

### é—®é¢˜3ï¼šè·¨åŸŸè¯·æ±‚è¢«æ‹¦æˆª
**åŸå› ï¼š** æµè§ˆå™¨CORSç­–ç•¥é™åˆ¶
**è§£å†³ï¼š**
1. ç¡®è®¤åç«¯CORSé…ç½®æ­£ç¡®
2. ä½¿ç”¨ç›¸å¯¹è·¯å¾„è€Œéç»å¯¹URL
3. æ£€æŸ¥è¯·æ±‚å¤´æ˜¯å¦åŒ…å« `Content-Type`

### é—®é¢˜4ï¼šæ³¨å†Œæ¥å£404
**åŸå› ï¼š** å‰ç«¯è°ƒç”¨åœ°å€é”™è¯¯
**è§£å†³ï¼š** å·²ä¿®å¤ä¸º `/api/user/register`

---

## ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env æ–‡ä»¶
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=your_secure_password
JWT_SECRET=your_jwt_secret_key
NODE_ENV=production
PORT=3003
```

### 2. å®‰å…¨åŠ å›º
- [ ] ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç 
- [ ] å¯ç”¨HTTPSï¼ˆé…ç½®SSLè¯ä¹¦ï¼‰
- [ ] è®¾ç½®å¼ºJWTå¯†é’¥
- [ ] é…ç½®æ•°æ®åº“å¤‡ä»½

### 3. æ€§èƒ½ä¼˜åŒ–
- [ ] å¯ç”¨gzipå‹ç¼©
- [ ] é…ç½®CDNåŠ é€Ÿ
- [ ] ä½¿ç”¨åå‘ä»£ç†ï¼ˆNginxï¼‰
- [ ] å¯ç”¨ç¼“å­˜ç­–ç•¥

### 4. ç›‘æ§å‘Šè­¦
- [ ] é…ç½®æ—¥å¿—æ”¶é›†
- [ ] è®¾ç½®é”™è¯¯å‘Šè­¦
- [ ] ç›‘æ§æœåŠ¡å¯ç”¨æ€§
- [ ] å®šæœŸå¤‡ä»½æ•°æ®åº“

---

## å¿«é€ŸéªŒè¯è„šæœ¬

```bash
#!/bin/bash
# ä¿å­˜ä¸º verify-deployment.sh

echo "ğŸ” éªŒè¯äº‘æœåŠ¡å™¨éƒ¨ç½²..."

# 1. æ£€æŸ¥åç«¯æœåŠ¡
echo "1ï¸âƒ£  æ£€æŸ¥åç«¯æœåŠ¡..."
curl -s http://47.83.203.60:3003/health | grep -q "ok" && echo "âœ… åç«¯æœåŠ¡æ­£å¸¸" || echo "âŒ åç«¯æœåŠ¡å¼‚å¸¸"

# 2. æ£€æŸ¥ç™»å½•æ¥å£
echo "2ï¸âƒ£  æ£€æŸ¥ç™»å½•æ¥å£..."
curl -s -X POST http://47.83.203.60:3003/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | grep -q "success" && echo "âœ… ç™»å½•æ¥å£æ­£å¸¸" || echo "âŒ ç™»å½•æ¥å£å¼‚å¸¸"

# 3. æ£€æŸ¥æ³¨å†Œæ¥å£
echo "3ï¸âƒ£  æ£€æŸ¥æ³¨å†Œæ¥å£..."
curl -s -X POST http://47.83.203.60:3003/api/user/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test123","sex":"male"}' | grep -q "success\|å·²å­˜åœ¨" && echo "âœ… æ³¨å†Œæ¥å£æ­£å¸¸" || echo "âŒ æ³¨å†Œæ¥å£å¼‚å¸¸"

echo "âœ¨ éªŒè¯å®Œæˆï¼"
```

---

## æ€»ç»“

é€šè¿‡æœ¬ä¿®å¤æ–¹æ¡ˆï¼Œå·²è§£å†³ï¼š
1. âœ… æ¥å£åœ°å€æ··ä¹± - ç»Ÿä¸€ä½¿ç”¨ç›¸å¯¹è·¯å¾„
2. âœ… è·¨åŸŸé…ç½®ç¼ºå¤± - å®Œæ•´çš„CORSé…ç½®
3. âœ… æ³¨å†Œæ¥å£ä¸å­˜åœ¨ - ç¡®è®¤æ¥å£å­˜åœ¨å¹¶ä¿®å¤å‰ç«¯è°ƒç”¨
4. âœ… é”™è¯¯å¤„ç†æ··ä¹± - è§„èŒƒçš„HTTPçŠ¶æ€ç å’Œå“åº”æ ¼å¼

**ä¸‹ä¸€æ­¥ï¼š** é‡å¯åç«¯æœåŠ¡å¹¶æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼Œå³å¯æ­£å¸¸ä½¿ç”¨ã€‚
